<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Toilet Map Admin Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --color-primary: #2563eb;
      --color-primary-dark: #1d4ed8;
      --color-success: #10b981;
      --color-danger: #ef4444;
      --color-warning: #f59e0b;
      --color-bg: #ffffff;
      --color-bg-secondary: #f9fafb;
      --color-border: #e5e7eb;
      --color-text: #111827;
      --color-text-secondary: #6b7280;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: var(--color-text);
      background: var(--color-bg-secondary);
      -webkit-font-smoothing: antialiased;
    }

    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      font-weight: 600;
    }

    button {
      font-family: inherit;
      cursor: pointer;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.15s ease;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--color-primary-dark);
    }

    .btn-secondary {
      background: white;
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--color-bg-secondary);
    }

    .btn-danger {
      background: var(--color-danger);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8125rem;
    }

    input, select, textarea {
      font-family: inherit;
      font-size: 0.875rem;
      padding: 0.5rem;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: white;
      width: 100%;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: var(--color-text);
    }

    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body
  data-auth0-enabled="__AUTH0_ENABLED__"
  data-auth0-client-id="__AUTH0_CLIENT_ID__"
  data-auth0-authorize-url="__AUTH0_AUTHORIZE_URL__"
  data-auth0-audience="__AUTH0_AUDIENCE__"
  data-auth0-scope="__AUTH0_SCOPE__"
  data-auth0-redirect-uri="__AUTH0_REDIRECT_URI__"
>
  <admin-app></admin-app>

  <script type="module">
    // ============================================================================
    // Constants
    // ============================================================================
    const ADMIN_ROLE_ID = 'rol_aC7YZZenLUd5kh9X';
    const API_BASE = '';

    // ============================================================================
    // Utilities
    // ============================================================================
    class EventBus {
      constructor() {
        this.listeners = {};
      }

      on(event, callback) {
        if (!this.listeners[event]) {
          this.listeners[event] = [];
        }
        this.listeners[event].push(callback);
      }

      off(event, callback) {
        if (!this.listeners[event]) return;
        this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);
      }

      emit(event, data) {
        if (!this.listeners[event]) return;
        this.listeners[event].forEach(callback => callback(data));
      }
    }

    const eventBus = new EventBus();

    // ============================================================================
    // Auth Service
    // ============================================================================
    class AuthService {
      constructor() {
        this.accessToken = null;
        this.user = null;
        this.config = {
          enabled: document.body.dataset.auth0Enabled === 'true',
          clientId: document.body.dataset.auth0ClientId,
          authorizeUrl: document.body.dataset.auth0AuthorizeUrl,
          audience: document.body.dataset.auth0Audience,
          scope: document.body.dataset.auth0Scope,
          redirectUri: document.body.dataset.auth0RedirectUri,
        };
      }

      async init() {
        // Check if we're on the callback page
        const hash = window.location.hash;
        if (hash && hash.includes('access_token')) {
          await this.handleCallback();
          return;
        }

        // Try to load token from storage
        const stored = localStorage.getItem('auth_token');
        if (stored) {
          try {
            const data = JSON.parse(stored);
            if (data.expiresAt > Date.now()) {
              this.accessToken = data.accessToken;
              await this.fetchUserInfo();
              return;
            }
          } catch (e) {
            localStorage.removeItem('auth_token');
          }
        }
      }

      async handleCallback() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const accessToken = params.get('access_token');
        const expiresIn = parseInt(params.get('expires_in') || '3600', 10);

        if (accessToken) {
          this.accessToken = accessToken;
          localStorage.setItem('auth_token', JSON.stringify({
            accessToken,
            expiresAt: Date.now() + (expiresIn * 1000)
          }));

          await this.fetchUserInfo();

          // Clean up URL
          window.history.replaceState(null, '', '/admin');
        }
      }

      async fetchUserInfo() {
        if (!this.accessToken) return;

        try {
          // Decode JWT to get user info
          const payload = JSON.parse(atob(this.accessToken.split('.')[1]));
          this.user = {
            sub: payload.sub,
            roles: payload['https://toiletmap.org.uk/roles'] || [],
          };
        } catch (e) {
          console.error('Failed to decode token:', e);
          this.logout();
        }
      }

      login() {
        const params = new URLSearchParams({
          client_id: this.config.clientId,
          response_type: 'token',
          redirect_uri: this.config.redirectUri,
          audience: this.config.audience,
          scope: this.config.scope,
        });

        window.location.href = `${this.config.authorizeUrl}?${params.toString()}`;
      }

      logout() {
        this.accessToken = null;
        this.user = null;
        localStorage.removeItem('auth_token');
        eventBus.emit('auth-changed', { authenticated: false });
      }

      isAuthenticated() {
        return !!this.accessToken && !!this.user;
      }

      hasAdminRole() {
        return this.user?.roles?.includes(ADMIN_ROLE_ID);
      }

      getToken() {
        return this.accessToken;
      }
    }

    const authService = new AuthService();

    // ============================================================================
    // API Service
    // ============================================================================
    class ApiService {
      async request(endpoint, options = {}) {
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers,
        };

        if (authService.isAuthenticated()) {
          headers['Authorization'] = `Bearer ${authService.getToken()}`;
        }

        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers,
        });

        if (!response.ok) {
          if (response.status === 401) {
            authService.logout();
            throw new Error('Unauthorized');
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        if (response.status === 204) {
          return null;
        }

        return response.json();
      }

      // Loos endpoints
      async searchLoos(params = {}) {
        const query = new URLSearchParams();
        Object.entries(params).forEach(([key, value]) => {
          if (value !== null && value !== undefined && value !== '') {
            query.append(key, value);
          }
        });
        return this.request(`/loos/search?${query.toString()}`);
      }

      async getLoo(id) {
        return this.request(`/loos/${id}`);
      }

      async createLoo(data) {
        return this.request('/loos', {
          method: 'POST',
          body: JSON.stringify(data),
        });
      }

      async updateLoo(id, data) {
        return this.request(`/loos/${id}`, {
          method: 'PUT',
          body: JSON.stringify(data),
        });
      }

      async deleteLoo(id) {
        return this.request(`/loos/${id}`, {
          method: 'DELETE',
        });
      }

      async getLooReports(id, hydrate = false) {
        return this.request(`/loos/${id}/reports?hydrate=${hydrate}`);
      }

      async getAreas() {
        return this.request('/areas');
      }
    }

    const apiService = new ApiService();

    // ============================================================================
    // Main App Component
    // ============================================================================
    class AdminApp extends HTMLElement {
      constructor() {
        super();
        this.currentView = 'list';
        this.selectedLooId = null;
      }

      async connectedCallback() {
        await authService.init();
        this.render();
        this.attachEventListeners();
      }

      attachEventListeners() {
        eventBus.on('auth-changed', () => this.render());
        eventBus.on('view-changed', (data) => {
          this.currentView = data.view;
          this.selectedLooId = data.looId || null;
          this.render();
        });
      }

      render() {
        if (!authService.isAuthenticated()) {
          this.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
              <div style="text-align: center; max-width: 400px; padding: 2rem;">
                <h1 style="margin-bottom: 1rem;">Toilet Map Admin</h1>
                <p style="color: var(--color-text-secondary); margin-bottom: 2rem;">
                  Sign in with your Auth0 account to access the admin panel.
                </p>
                <button class="btn-primary" onclick="authService.login()">
                  Sign in with Auth0
                </button>
              </div>
            </div>
          `;
          return;
        }

        if (!authService.hasAdminRole()) {
          this.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
              <div style="text-align: center; max-width: 400px; padding: 2rem;">
                <h1 style="margin-bottom: 1rem;">Access Denied</h1>
                <p style="color: var(--color-text-secondary); margin-bottom: 2rem;">
                  You do not have admin privileges. Please contact an administrator.
                </p>
                <button class="btn-secondary" onclick="authService.logout()">
                  Sign Out
                </button>
              </div>
            </div>
          `;
          return;
        }

        this.innerHTML = `
          <div style="display: flex; min-height: 100vh;">
            <admin-sidebar></admin-sidebar>
            <main style="flex: 1; padding: 2rem;">
              ${this.renderView()}
            </main>
          </div>
        `;
      }

      renderView() {
        switch (this.currentView) {
          case 'list':
            return '<loo-list></loo-list>';
          case 'edit':
            return `<loo-editor loo-id="${this.selectedLooId || ''}"></loo-editor>`;
          case 'map':
            return '<loo-map></loo-map>';
          default:
            return '<loo-list></loo-list>';
        }
      }
    }

    customElements.define('admin-app', AdminApp);

    // ============================================================================
    // Sidebar Component
    // ============================================================================
    class AdminSidebar extends HTMLElement {
      connectedCallback() {
        this.render();
      }

      navigate(view) {
        eventBus.emit('view-changed', { view });
      }

      render() {
        this.innerHTML = `
          <aside style="width: 240px; background: white; border-right: 1px solid var(--color-border); padding: 1.5rem;">
            <h2 style="margin-bottom: 2rem; font-size: 1.25rem;">Admin Panel</h2>
            <nav style="display: flex; flex-direction: column; gap: 0.5rem;">
              <button class="btn-secondary" onclick="this.getRootNode().host.navigate('list')" style="justify-content: flex-start;">
                üìã Loo List
              </button>
              <button class="btn-secondary" onclick="this.getRootNode().host.navigate('map')" style="justify-content: flex-start;">
                üó∫Ô∏è Map View
              </button>
              <button class="btn-secondary" onclick="this.getRootNode().host.navigate('edit')" style="justify-content: flex-start;">
                ‚ûï Add New Loo
              </button>
            </nav>
            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--color-border); margin-top: 2rem;">
              <button class="btn-secondary" onclick="authService.logout()" style="width: 100%;">
                Sign Out
              </button>
            </div>
          </aside>
        `;
      }
    }

    customElements.define('admin-sidebar', AdminSidebar);

    // ============================================================================
    // Loo List Component
    // ============================================================================
    class LooList extends HTMLElement {
      constructor() {
        super();
        this.loos = [];
        this.loading = false;
        this.page = 1;
        this.pageSize = 20;
        this.total = 0;
        this.searchTerm = '';
        this.filters = {
          active: 'any',
          accessible: 'any',
          verified: 'any',
        };
      }

      async connectedCallback() {
        this.render();
        await this.loadLoos();
      }

      async loadLoos() {
        this.loading = true;
        this.render();

        try {
          const params = {
            page: this.page,
            limit: this.pageSize,
            sort: 'updated-desc',
          };

          if (this.searchTerm) {
            params.search = this.searchTerm;
          }

          Object.entries(this.filters).forEach(([key, value]) => {
            if (value !== 'any') {
              params[key] = value;
            }
          });

          const response = await apiService.searchLoos(params);
          this.loos = response.data;
          this.total = response.total;
          this.loading = false;
          this.render();
        } catch (error) {
          console.error('Failed to load loos:', error);
          this.loading = false;
          this.render();
        }
      }

      handleSearch(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        this.searchTerm = formData.get('search');
        this.page = 1;
        this.loadLoos();
      }

      handleFilterChange(key, value) {
        this.filters[key] = value;
        this.page = 1;
        this.loadLoos();
      }

      changePage(newPage) {
        this.page = newPage;
        this.loadLoos();
      }

      viewLoo(id) {
        eventBus.emit('view-changed', { view: 'edit', looId: id });
      }

      async deleteLoo(id) {
        if (!confirm('Are you sure you want to delete this loo?')) {
          return;
        }

        try {
          await apiService.deleteLoo(id);
          await this.loadLoos();
        } catch (error) {
          alert('Failed to delete loo: ' + error.message);
        }
      }

      render() {
        const totalPages = Math.ceil(this.total / this.pageSize);

        this.innerHTML = `
          <div style="max-width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h1 style="font-size: 1.5rem;">Loos (${this.total})</h1>
              <button class="btn-primary" onclick="this.getRootNode().host.viewLoo(null)">
                Add New Loo
              </button>
            </div>

            <div style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm);">
              <form onsubmit="this.getRootNode().host.handleSearch(event); return false;">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                  <input
                    type="text"
                    name="search"
                    placeholder="Search by name, area, or notes..."
                    value="${this.searchTerm}"
                    style="flex: 1;"
                  >
                  <button type="submit" class="btn-primary">Search</button>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                  <div>
                    <label>Active</label>
                    <select onchange="this.getRootNode().host.handleFilterChange('active', this.value)">
                      <option value="any" ${this.filters.active === 'any' ? 'selected' : ''}>Any</option>
                      <option value="true" ${this.filters.active === 'true' ? 'selected' : ''}>Yes</option>
                      <option value="false" ${this.filters.active === 'false' ? 'selected' : ''}>No</option>
                    </select>
                  </div>
                  <div>
                    <label>Accessible</label>
                    <select onchange="this.getRootNode().host.handleFilterChange('accessible', this.value)">
                      <option value="any" ${this.filters.accessible === 'any' ? 'selected' : ''}>Any</option>
                      <option value="true" ${this.filters.accessible === 'true' ? 'selected' : ''}>Yes</option>
                      <option value="false" ${this.filters.accessible === 'false' ? 'selected' : ''}>No</option>
                    </select>
                  </div>
                  <div>
                    <label>Verified</label>
                    <select onchange="this.getRootNode().host.handleFilterChange('verified', this.value)">
                      <option value="any" ${this.filters.verified === 'any' ? 'selected' : ''}>Any</option>
                      <option value="true" ${this.filters.verified === 'true' ? 'selected' : ''}>Yes</option>
                      <option value="false" ${this.filters.verified === 'false' ? 'selected' : ''}>No</option>
                    </select>
                  </div>
                </div>
              </form>
            </div>

            ${this.loading ? `
              <div style="text-align: center; padding: 3rem;">
                <div class="loading" style="width: 2rem; height: 2rem;"></div>
              </div>
            ` : `
              <div style="background: white; border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm);">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead style="background: var(--color-bg-secondary); border-bottom: 1px solid var(--color-border);">
                    <tr>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-secondary);">Name</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-secondary);">Area</th>
                      <th style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-secondary);">Status</th>
                      <th style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-secondary);">Features</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-secondary);">Updated</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-secondary);">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${this.loos.length === 0 ? `
                      <tr>
                        <td colspan="6" style="padding: 3rem; text-align: center; color: var(--color-text-secondary);">
                          No loos found
                        </td>
                      </tr>
                    ` : this.loos.map(loo => `
                      <tr style="border-bottom: 1px solid var(--color-border);">
                        <td style="padding: 0.75rem;">
                          <div style="font-weight: 500;">${loo.name || 'Unnamed'}</div>
                          <div style="font-size: 0.75rem; color: var(--color-text-secondary);">${loo.id}</div>
                        </td>
                        <td style="padding: 0.75rem;">
                          <div style="font-size: 0.875rem;">${loo.area?.[0]?.name || 'No area'}</div>
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                          ${loo.active ?
                            '<span style="display: inline-block; padding: 0.25rem 0.5rem; background: #d1fae5; color: #065f46; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 500;">Active</span>' :
                            '<span style="display: inline-block; padding: 0.25rem 0.5rem; background: #fee2e2; color: #991b1b; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 500;">Inactive</span>'
                          }
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                          <div style="display: flex; gap: 0.25rem; justify-content: center; flex-wrap: wrap;">
                            ${loo.accessible ? '<span title="Accessible">‚ôø</span>' : ''}
                            ${loo.babyChange ? '<span title="Baby Change">üçº</span>' : ''}
                            ${loo.radar ? '<span title="RADAR">üîë</span>' : ''}
                            ${loo.noPayment ? '<span title="Free">üíö</span>' : ''}
                          </div>
                        </td>
                        <td style="padding: 0.75rem;">
                          <div style="font-size: 0.875rem;">${loo.updatedAt ? new Date(loo.updatedAt).toLocaleDateString() : 'N/A'}</div>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                          <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button
                              class="btn-sm btn-secondary"
                              onclick="this.getRootNode().host.viewLoo('${loo.id}')"
                            >
                              View
                            </button>
                            <button
                              class="btn-sm btn-danger"
                              onclick="this.getRootNode().host.deleteLoo('${loo.id}')"
                            >
                              Delete
                            </button>
                          </div>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>

              ${totalPages > 1 ? `
                <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 1.5rem;">
                  <button
                    class="btn-secondary btn-sm"
                    onclick="this.getRootNode().host.changePage(${this.page - 1})"
                    ${this.page === 1 ? 'disabled' : ''}
                  >
                    Previous
                  </button>
                  <span style="padding: 0 1rem; color: var(--color-text-secondary);">
                    Page ${this.page} of ${totalPages}
                  </span>
                  <button
                    class="btn-secondary btn-sm"
                    onclick="this.getRootNode().host.changePage(${this.page + 1})"
                    ${this.page === totalPages ? 'disabled' : ''}
                  >
                    Next
                  </button>
                </div>
              ` : ''}
            `}
          </div>
        `;
      }
    }

    customElements.define('loo-list', LooList);

    // ============================================================================
    // Loo Editor Component
    // ============================================================================
    class LooEditor extends HTMLElement {
      constructor() {
        super();
        this.loo = null;
        this.loading = false;
        this.saving = false;
        this.isNew = true;
        this.showReports = false;
      }

      static get observedAttributes() {
        return ['loo-id'];
      }

      async connectedCallback() {
        const looId = this.getAttribute('loo-id');
        this.isNew = !looId;
        this.render();

        if (looId) {
          await this.loadLoo(looId);
        }
      }

      async loadLoo(id) {
        this.loading = true;
        this.render();

        try {
          this.loo = await apiService.getLoo(id);
          this.loading = false;
          this.render();
        } catch (error) {
          console.error('Failed to load loo:', error);
          alert('Failed to load loo: ' + error.message);
          this.loading = false;
          this.render();
        }
      }

      async handleSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const data = {
          name: formData.get('name') || null,
          active: formData.get('active') === 'true',
          accessible: formData.get('accessible') === 'true',
          allGender: formData.get('allGender') === 'true',
          attended: formData.get('attended') === 'true',
          automatic: formData.get('automatic') === 'true',
          babyChange: formData.get('babyChange') === 'true',
          children: formData.get('children') === 'true',
          men: formData.get('men') === 'true',
          women: formData.get('women') === 'true',
          radar: formData.get('radar') === 'true',
          urinalOnly: formData.get('urinalOnly') === 'true',
          noPayment: formData.get('noPayment') === 'true',
          paymentDetails: formData.get('paymentDetails') || null,
          notes: formData.get('notes') || null,
          removalReason: formData.get('removalReason') || null,
        };

        const lat = formData.get('lat');
        const lng = formData.get('lng');
        if (lat && lng) {
          data.location = {
            lat: parseFloat(lat),
            lng: parseFloat(lng),
          };
        }

        this.saving = true;
        this.render();

        try {
          if (this.isNew) {
            const result = await apiService.createLoo(data);
            alert('Loo created successfully!');
            eventBus.emit('view-changed', { view: 'edit', looId: result.id });
          } else {
            await apiService.updateLoo(this.loo.id, data);
            alert('Loo updated successfully!');
            await this.loadLoo(this.loo.id);
          }
          this.saving = false;
        } catch (error) {
          console.error('Failed to save loo:', error);
          alert('Failed to save loo: ' + error.message);
          this.saving = false;
          this.render();
        }
      }

      goBack() {
        eventBus.emit('view-changed', { view: 'list' });
      }

      toggleReports() {
        this.showReports = !this.showReports;
        this.render();
      }

      render() {
        if (this.loading) {
          this.innerHTML = `
            <div style="text-align: center; padding: 3rem;">
              <div class="loading" style="width: 2rem; height: 2rem;"></div>
            </div>
          `;
          return;
        }

        const loo = this.loo || {};

        this.innerHTML = `
          <div style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="btn-secondary" onclick="this.getRootNode().host.goBack()">
                  ‚Üê Back
                </button>
                <h1 style="font-size: 1.5rem;">${this.isNew ? 'Add New Loo' : 'Edit Loo'}</h1>
              </div>
              ${!this.isNew ? `
                <button class="btn-secondary" onclick="this.getRootNode().host.toggleReports()">
                  ${this.showReports ? 'Hide' : 'Show'} History
                </button>
              ` : ''}
            </div>

            <div style="display: grid; gap: 2rem; grid-template-columns: ${this.showReports && !this.isNew ? '1fr 400px' : '1fr'};">
              <div style="background: white; border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-sm);">
                <form onsubmit="this.getRootNode().host.handleSubmit(event); return false;">
                  <div style="display: grid; gap: 1.5rem;">
                    <div>
                      <label>Name</label>
                      <input type="text" name="name" value="${loo.name || ''}" placeholder="Enter loo name">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                      <div>
                        <label>Latitude</label>
                        <input
                          type="number"
                          step="any"
                          name="lat"
                          value="${loo.location?.lat || ''}"
                          placeholder="51.5074"
                        >
                      </div>
                      <div>
                        <label>Longitude</label>
                        <input
                          type="number"
                          step="any"
                          name="lng"
                          value="${loo.location?.lng || ''}"
                          placeholder="-0.1278"
                        >
                      </div>
                    </div>

                    <div>
                      <h3 style="margin-bottom: 1rem; font-size: 1rem;">Status</h3>
                      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="active" value="true" ${loo.active ? 'checked' : ''}>
                            Active
                          </label>
                        </div>
                      </div>
                    </div>

                    <div>
                      <h3 style="margin-bottom: 1rem; font-size: 1rem;">Accessibility</h3>
                      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="accessible" value="true" ${loo.accessible ? 'checked' : ''}>
                            Accessible
                          </label>
                        </div>
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="radar" value="true" ${loo.radar ? 'checked' : ''}>
                            RADAR Key
                          </label>
                        </div>
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="babyChange" value="true" ${loo.babyChange ? 'checked' : ''}>
                            Baby Change
                          </label>
                        </div>
                      </div>
                    </div>

                    <div>
                      <h3 style="margin-bottom: 1rem; font-size: 1rem;">Gender Facilities</h3>
                      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="men" value="true" ${loo.men ? 'checked' : ''}>
                            Men
                          </label>
                        </div>
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="women" value="true" ${loo.women ? 'checked' : ''}>
                            Women
                          </label>
                        </div>
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="allGender" value="true" ${loo.allGender ? 'checked' : ''}>
                            All Gender
                          </label>
                        </div>
                      </div>
                    </div>

                    <div>
                      <h3 style="margin-bottom: 1rem; font-size: 1rem;">Additional Features</h3>
                      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="attended" value="true" ${loo.attended ? 'checked' : ''}>
                            Attended
                          </label>
                        </div>
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="automatic" value="true" ${loo.automatic ? 'checked' : ''}>
                            Automatic
                          </label>
                        </div>
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="children" value="true" ${loo.children ? 'checked' : ''}>
                            Children
                          </label>
                        </div>
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="urinalOnly" value="true" ${loo.urinalOnly ? 'checked' : ''}>
                            Urinal Only
                          </label>
                        </div>
                        <div>
                          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="noPayment" value="true" ${loo.noPayment ? 'checked' : ''}>
                            Free (No Payment)
                          </label>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label>Payment Details</label>
                      <input type="text" name="paymentDetails" value="${loo.paymentDetails || ''}" placeholder="e.g., 20p coin required">
                    </div>

                    <div>
                      <label>Notes</label>
                      <textarea name="notes" rows="4" placeholder="Additional notes...">${loo.notes || ''}</textarea>
                    </div>

                    <div>
                      <label>Removal Reason</label>
                      <input type="text" name="removalReason" value="${loo.removalReason || ''}" placeholder="Reason if marked inactive">
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                      <button type="button" class="btn-secondary" onclick="this.getRootNode().host.goBack()">
                        Cancel
                      </button>
                      <button type="submit" class="btn-primary" ${this.saving ? 'disabled' : ''}>
                        ${this.saving ? 'Saving...' : (this.isNew ? 'Create Loo' : 'Save Changes')}
                      </button>
                    </div>
                  </div>
                </form>
              </div>

              ${this.showReports && !this.isNew ? `
                <report-timeline loo-id="${this.loo.id}"></report-timeline>
              ` : ''}
            </div>
          </div>
        `;
      }
    }

    customElements.define('loo-editor', LooEditor);

    // ============================================================================
    // Report Timeline Component
    // ============================================================================
    class ReportTimeline extends HTMLElement {
      constructor() {
        super();
        this.reports = [];
        this.loading = false;
      }

      static get observedAttributes() {
        return ['loo-id'];
      }

      async connectedCallback() {
        const looId = this.getAttribute('loo-id');
        if (looId) {
          await this.loadReports(looId);
        }
      }

      async loadReports(id) {
        this.loading = true;
        this.render();

        try {
          const response = await apiService.getLooReports(id, true);
          this.reports = response.data || [];
          this.loading = false;
          this.render();
        } catch (error) {
          console.error('Failed to load reports:', error);
          this.loading = false;
          this.render();
        }
      }

      formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('en-GB', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      renderDiff(diff) {
        if (!diff || Object.keys(diff).length === 0) {
          return '<span style="color: var(--color-text-secondary); font-size: 0.875rem;">No changes</span>';
        }

        return Object.entries(diff).map(([field, change]) => {
          const formatValue = (val) => {
            if (val === null || val === undefined) return 'null';
            if (typeof val === 'boolean') return val ? 'true' : 'false';
            if (typeof val === 'object') return JSON.stringify(val);
            return String(val);
          };

          return `
            <div style="margin-bottom: 0.5rem; font-size: 0.875rem;">
              <strong>${field}:</strong>
              <span style="color: var(--color-danger); text-decoration: line-through;">${formatValue(change.previous)}</span>
              ‚Üí
              <span style="color: var(--color-success);">${formatValue(change.current)}</span>
            </div>
          `;
        }).join('');
      }

      render() {
        this.innerHTML = `
          <div style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-sm); max-height: 800px; overflow-y: auto;">
            <h3 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">Report History</h3>

            ${this.loading ? `
              <div style="text-align: center; padding: 2rem;">
                <div class="loading"></div>
              </div>
            ` : `
              ${this.reports.length === 0 ? `
                <p style="color: var(--color-text-secondary); text-align: center; padding: 2rem;">
                  No reports found
                </p>
              ` : `
                <div style="position: relative; padding-left: 1.5rem;">
                  <div style="position: absolute; left: 0.25rem; top: 0; bottom: 0; width: 2px; background: var(--color-border);"></div>
                  ${this.reports.map((report, index) => `
                    <div style="position: relative; margin-bottom: ${index === this.reports.length - 1 ? '0' : '1.5rem'};">
                      <div style="position: absolute; left: -1.25rem; top: 0.25rem; width: 0.75rem; height: 0.75rem; border-radius: 50%; background: ${report.isSystemReport ? 'var(--color-warning)' : 'var(--color-primary)'}; border: 2px solid white;"></div>
                      <div style="background: var(--color-bg-secondary); border-radius: var(--radius-md); padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                          <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">
                              ${report.contributor || 'Unknown'}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--color-text-secondary);">
                              ${this.formatDate(report.createdAt)}
                            </div>
                          </div>
                          ${report.isSystemReport ? `
                            <span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: var(--color-warning); color: white; border-radius: var(--radius-sm);">
                              System
                            </span>
                          ` : ''}
                        </div>
                        ${this.renderDiff(report.diff)}
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            `}
          </div>
        `;
      }
    }

    customElements.define('report-timeline', ReportTimeline);

    // Make services available globally for button handlers
    window.authService = authService;
    window.eventBus = eventBus;
    window.apiService = apiService;
  </script>
</body>
</html>
