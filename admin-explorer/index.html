<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Toiletmap Admin Explorer</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #0f172a;
        background: #f6f8fd;
        color-scheme: light;
        --page-bg: #f6f8fd;
        --surface: rgba(255, 255, 255, 0.97);
        --surface-border: rgba(15, 23, 42, 0.08);
        --surface-shadow: 0 28px 50px -35px rgba(15, 23, 42, 0.4);
        --muted: rgba(15, 23, 42, 0.65);
        --muted-strong: rgba(15, 23, 42, 0.85);
        --accent: #2563eb;
        --accent-soft: rgba(37, 99, 235, 0.12);
        --accent-strong: #1d4ed8;
        --success: #16a34a;
        --success-soft: rgba(22, 163, 74, 0.12);
        --error: #dc2626;
        --error-soft: rgba(220, 38, 38, 0.12);
        --outline: rgba(37, 99, 235, 0.25);
        --outline-strong: rgba(37, 99, 235, 0.4);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          color: #e2e8f0;
          background: #020617;
          color-scheme: dark;
          --page-bg: #020617;
          --surface: rgba(15, 23, 42, 0.9);
          --surface-border: rgba(148, 163, 184, 0.18);
          --surface-shadow: 0 32px 60px -40px rgba(2, 6, 23, 0.85);
          --muted: rgba(226, 232, 240, 0.72);
          --muted-strong: rgba(226, 232, 240, 0.9);
          --accent: #60a5fa;
          --accent-strong: #3b82f6;
          --accent-soft: rgba(96, 165, 250, 0.2);
          --success: #34d399;
          --success-soft: rgba(52, 211, 153, 0.18);
          --error: #f87171;
          --error-soft: rgba(248, 113, 113, 0.18);
          --outline: rgba(96, 165, 250, 0.35);
          --outline-strong: rgba(96, 165, 250, 0.5);
        }
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--page-bg);
        color: inherit;
      }

      tm-admin-app {
        display: block;
      }

      .admin-app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      main.admin-shell {
        flex: 1;
        display: grid;
        gap: 24px;
        align-items: start;
        padding: 28px clamp(16px, 4vw, 48px) 40px;
        grid-template-columns: minmax(260px, 320px) 1fr;
      }

      .surface {
        background: var(--surface);
        border-radius: 22px;
        border: 1px solid var(--surface-border);
        box-shadow: var(--surface-shadow);
      }

      .panel {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .panel__header {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: space-between;
        align-items: flex-start;
      }

      .panel__title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      .panel__description {
        margin: 6px 0 0;
        font-size: 0.92rem;
        color: var(--muted);
        max-width: 48ch;
      }

      .panel__actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .panel__summary {
        margin: 8px 0 0;
        font-size: 0.82rem;
        color: var(--muted);
      }

      .btn {
        appearance: none;
        border: none;
        border-radius: 999px;
        padding: 9px 18px;
        font-weight: 600;
        font-size: 0.92rem;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease,
          background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
      }

      .btn-primary {
        color: #f8fafc;
        background: linear-gradient(120deg, var(--accent), var(--accent-strong));
        box-shadow: 0 18px 36px -26px var(--accent-strong);
      }

      .btn-secondary {
        background: rgba(15, 23, 42, 0.05);
        color: var(--muted-strong);
        border: 1px solid rgba(15, 23, 42, 0.08);
      }

      .btn-ghost {
        background: transparent;
        color: var(--accent);
        border: 1px solid var(--outline);
      }

      @media (prefers-color-scheme: dark) {
        .btn-secondary {
          background: rgba(148, 163, 184, 0.12);
          color: var(--muted);
          border-color: rgba(148, 163, 184, 0.18);
        }

        .btn-ghost {
          color: var(--accent);
          border-color: rgba(96, 165, 250, 0.3);
          background: rgba(96, 165, 250, 0.08);
        }
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      input,
      select,
      textarea {
        width: 100%;
        font: inherit;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.92);
        transition: border-color 0.2s ease, box-shadow 0.2s ease,
          background 0.2s ease;
      }

      textarea {
        resize: vertical;
        min-height: 96px;
      }

      @media (prefers-color-scheme: dark) {
        input,
        select,
        textarea {
          background: rgba(15, 23, 42, 0.85);
          border-color: rgba(148, 163, 184, 0.24);
          color: inherit;
        }
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--outline-strong);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
      }

      .field-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .field-label {
        font-size: 0.82rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      fieldset {
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 16px;
        padding: 16px;
        margin: 0;
        display: grid;
        gap: 16px;
      }

      @media (prefers-color-scheme: dark) {
        fieldset {
          border-color: rgba(148, 163, 184, 0.2);
        }
      }

      legend {
        font-weight: 600;
        font-size: 0.95rem;
        padding: 0 6px;
        color: var(--muted-strong);
      }

      .field-grid {
        display: grid;
        gap: 14px;
      }

      .field-grid--two {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .field-grid--three {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 0.78rem;
        font-weight: 600;
        background: var(--accent-soft);
        color: var(--accent-strong);
        border: 1px solid rgba(37, 99, 235, 0.18);
      }

      .chip--success {
        background: var(--success-soft);
        color: var(--success);
        border-color: rgba(22, 163, 74, 0.28);
      }

      .chip--neutral {
        background: rgba(15, 23, 42, 0.08);
        color: var(--muted-strong);
        border-color: rgba(15, 23, 42, 0.12);
      }

      @media (prefers-color-scheme: dark) {
        .chip--neutral {
          background: rgba(148, 163, 184, 0.15);
          color: var(--muted);
          border-color: rgba(148, 163, 184, 0.25);
        }
      }

      .results-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        justify-content: flex-end;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .pagination-controls {
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .pagination-status {
        font-weight: 600;
      }

      .table-scroll {
        width: 100%;
        overflow: auto;
        border-radius: 16px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        background: rgba(255, 255, 255, 0.92);
      }

      @media (prefers-color-scheme: dark) {
        .table-scroll {
          border-color: rgba(148, 163, 184, 0.2);
          background: rgba(15, 23, 42, 0.8);
        }
      }

      table.results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      table.results-table thead {
        background: rgba(37, 99, 235, 0.08);
      }

      @media (prefers-color-scheme: dark) {
        table.results-table thead {
          background: rgba(96, 165, 250, 0.16);
        }
      }

      table.results-table th,
      table.results-table td {
        padding: 12px 14px;
        text-align: left;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      }

      @media (prefers-color-scheme: dark) {
        table.results-table th,
        table.results-table td {
          border-bottom-color: rgba(148, 163, 184, 0.16);
        }
      }

      table.results-table th {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-weight: 600;
        color: var(--muted);
      }

      tr.result-row {
        cursor: pointer;
        transition: background 0.18s ease;
      }

      tr.result-row:hover {
        background: rgba(37, 99, 235, 0.08);
      }

      tr.result-row.selected {
        background: rgba(37, 99, 235, 0.16);
      }

      @media (prefers-color-scheme: dark) {
        tr.result-row:hover {
          background: rgba(96, 165, 250, 0.18);
        }

        tr.result-row.selected {
          background: rgba(96, 165, 250, 0.25);
        }
      }

      code {
        font-family: 'JetBrains Mono', 'Fira Mono', 'Source Code Pro', monospace;
        font-size: 0.85em;
      }

      .results-status {
        text-align: center;
        border-radius: 16px;
        border: 1px dashed rgba(15, 23, 42, 0.15);
        padding: 32px 20px;
        font-size: 0.95rem;
      }

      @media (prefers-color-scheme: dark) {
        .results-status {
          border-color: rgba(148, 163, 184, 0.25);
        }
      }

      .results-status strong {
        display: block;
        margin-bottom: 6px;
        font-size: 1rem;
      }

      .map-wrapper {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .map-container {
        height: 360px;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(15, 23, 42, 0.08);
      }

      @media (prefers-color-scheme: dark) {
        .map-container {
          border-color: rgba(148, 163, 184, 0.2);
        }
      }

      .map-hint {
        font-size: 0.82rem;
        color: var(--muted);
      }

      .workspace {
        display: grid;
        gap: 24px;
      }

      .split-layout {
        display: grid;
        gap: 24px;
        grid-template-columns: minmax(260px, 1fr) minmax(300px, 420px);
      }

      @media (max-width: 1320px) {
        main.admin-shell {
          grid-template-columns: 1fr;
        }

        .split-layout {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 880px) {
        main.admin-shell {
          padding: 20px 16px 28px;
          gap: 20px;
        }
      }

      tm-admin-header.panel {
        gap: 20px;
      }

      .header {
        display: grid;
        gap: 18px;
      }

      @media (min-width: 880px) {
        .header {
          grid-template-columns: 1fr minmax(280px, 360px);
          align-items: stretch;
        }
      }

      .header__title {
        margin: 0;
        font-size: clamp(1.6rem, 2vw + 1rem, 2rem);
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .header__subtitle {
        margin: 10px 0 0;
        font-size: 1rem;
        color: var(--muted);
        max-width: 60ch;
      }

      .header__badge {
        margin-top: 12px;
        display: inline-flex;
        gap: 6px;
        font-size: 0.85rem;
        align-items: center;
        color: var(--muted);
      }

      .header__actions {
        display: grid;
        gap: 18px;
        align-content: start;
      }

      .header__oauth {
        display: grid;
        gap: 6px;
      }

      .header__hint {
        font-size: 0.82rem;
        color: var(--muted);
      }

      .header__token {
        display: grid;
        gap: 6px;
      }

      .token-control {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .token-control input {
        flex: 1;
      }

      .token-control .btn {
        padding: 8px 14px;
        font-size: 0.82rem;
      }

      .header__token-hint {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .header__flash {
        padding: 12px 16px;
        border-radius: 14px;
        font-size: 0.9rem;
      }

      .header__flash.info {
        background: var(--accent-soft);
        color: var(--accent-strong);
      }

      .header__flash.success {
        background: var(--success-soft);
        color: var(--success);
      }

      .header__flash.error {
        background: var(--error-soft);
        color: var(--error);
      }

      .detail__header {
        align-items: center;
      }

      .detail__subtitle {
        margin: 6px 0 0;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .detail__badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .detail__body {
        display: grid;
        gap: 20px;
      }

      .detail__meta {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .detail__meta dt {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .detail__meta dd {
        margin: 0;
        font-size: 0.92rem;
        color: var(--muted-strong);
      }

      .detail__tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .detail__notes {
        display: grid;
        gap: 14px;
      }

      .detail-note {
        padding: 14px 16px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        background: rgba(255, 255, 255, 0.96);
      }

      @media (prefers-color-scheme: dark) {
        .detail-note {
          border-color: rgba(148, 163, 184, 0.22);
          background: rgba(15, 23, 42, 0.8);
        }
      }

      .detail-note h3 {
        margin: 0 0 6px;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .detail-note p {
        margin: 0;
        font-size: 0.9rem;
      }

      .detail__reports {
        display: grid;
        gap: 12px;
      }

      .reports-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .reports-grid span {
        font-size: 0.85rem;
        color: var(--muted-strong);
      }

      .reports-grid strong {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 4px;
        color: var(--muted);
      }

      .reports-list {
        display: grid;
        gap: 10px;
        max-height: 220px;
        overflow: auto;
        padding-right: 4px;
      }

      .reports-item {
        border-radius: 12px;
        padding: 12px 14px;
        background: rgba(37, 99, 235, 0.08);
        display: grid;
        gap: 6px;
      }

      @media (prefers-color-scheme: dark) {
        .reports-item {
          background: rgba(96, 165, 250, 0.18);
        }
      }

      .reports-item__header {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        font-size: 0.88rem;
      }

      .reports-item__meta {
        font-size: 0.78rem;
        color: var(--muted);
      }

      .reports-empty,
      .reports-error {
        padding: 14px 16px;
        border-radius: 12px;
        font-size: 0.88rem;
      }

      .reports-empty {
        background: rgba(15, 23, 42, 0.05);
        color: var(--muted-strong);
      }

      .reports-error {
        background: var(--error-soft);
        color: var(--error);
      }

      .edit-form {
        display: grid;
        gap: 16px;
      }

      .edit-form .field-grid--three {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }

      .location-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(120px, 1fr));
        gap: 12px;
      }

      .status-message {
        padding: 12px 14px;
        border-radius: 12px;
        font-size: 0.88rem;
      }

      .status-message.success {
        background: var(--success-soft);
        color: var(--success);
      }

      .status-message.error {
        background: var(--error-soft);
        color: var(--error);
      }

      .detail__actions {
        display: flex;
        justify-content: flex-end;
      }

      footer.admin-footer {
        padding: 20px clamp(16px, 4vw, 48px) 32px;
        font-size: 0.82rem;
        text-align: center;
        color: var(--muted);
      }

      .leaflet-control-attribution a {
        color: inherit;
      }

      @media (max-width: 720px) {
        .header__actions {
          grid-template-columns: 1fr;
        }

        .token-control {
          flex-wrap: wrap;
        }

        .token-control .btn {
          width: calc(50% - 4px);
        }
      }
    </style>
  </head>
  <body>
    <tm-admin-app
      data-auth0-enabled="__AUTH0_ENABLED__"
      data-auth0-client-id="__AUTH0_CLIENT_ID__"
      data-auth0-authorize-url="__AUTH0_AUTHORIZE_URL__"
      data-auth0-audience="__AUTH0_AUDIENCE__"
      data-auth0-scope="__AUTH0_SCOPE__"
      data-auth0-redirect-uri="__AUTH0_REDIRECT_URI__"
    ></tm-admin-app>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script type="module">
      (() => {
        const STORAGE_KEY = 'toiletmap-admin-token';
        const AUTH_STATE_STORAGE_KEY = 'toiletmap-admin-oauth-state';

        const TRI_STATE_FILTER_OPTIONS = [
          { value: 'any', label: 'Any' },
          { value: 'true', label: 'Yes' },
          { value: 'false', label: 'No' },
          { value: 'null', label: 'Unknown' },
        ];
        const BOOLEAN_FILTER_OPTIONS = [
          { value: 'any', label: 'Any' },
          { value: 'true', label: 'Yes' },
          { value: 'false', label: 'No' },
        ];
        const SORT_OPTIONS = [
          { value: 'updated-desc', label: 'Recent updates' },
          { value: 'updated-asc', label: 'Oldest updates' },
          { value: 'created-desc', label: 'Newest first' },
          { value: 'created-asc', label: 'Oldest first' },
          { value: 'verified-desc', label: 'Most recently verified' },
          { value: 'verified-asc', label: 'Least recently verified' },
          { value: 'name-asc', label: 'Name A→Z' },
          { value: 'name-desc', label: 'Name Z→A' },
        ];
        const PAGE_SIZE_OPTIONS = [20, 50, 100, 150, 200];

        const createDefaultFilters = () => ({
          search: '',
          areaName: '',
          areaType: '',
          active: 'any',
          accessible: 'any',
          allGender: 'any',
          radar: 'any',
          babyChange: 'any',
          noPayment: 'any',
          verified: 'any',
          hasLocation: 'any',
          limit: 50,
          page: 1,
          sort: 'updated-desc',
        });

        const DEFAULT_FILTER_TEMPLATE = createDefaultFilters();

        const formatDateTime = (value) => {
          if (!value) {
            return '—';
          }
          try {
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
              return String(value);
            }
            return date.toLocaleString(undefined, {
              dateStyle: 'medium',
              timeStyle: 'short',
            });
          } catch (error) {
            return String(value);
          }
        };

        const formatRelative = (value) => {
          if (!value) {
            return '—';
          }
          try {
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
              return '—';
            }
            const diff = Date.now() - date.getTime();
            const minutes = Math.round(diff / 60000);
            if (minutes < 60) {
              return minutes + 'm ago';
            }
            const hours = Math.round(minutes / 60);
            if (hours < 48) {
              return hours + 'h ago';
            }
            const days = Math.round(hours / 24);
            if (days < 90) {
              return days + 'd ago';
            }
            const months = Math.round(days / 30);
            if (months < 36) {
              return months + 'mo ago';
            }
            const years = Math.round(months / 12);
            return years + 'y ago';
          } catch (error) {
            return '—';
          }
        };

        const formatFlag = (value) => {
          if (value === true) return 'Yes';
          if (value === false) return 'No';
          return 'Unknown';
        };

        const booleanToOption = (value) => {
          if (value === true) return 'true';
          if (value === false) return 'false';
          return 'null';
        };

        const optionToBoolean = (value) => {
          if (value === 'true') return true;
          if (value === 'false') return false;
          return null;
        };

        const buildSearchParams = (filters) => {
          const params = new URLSearchParams();
          if (filters.search && filters.search.trim()) params.set('search', filters.search.trim());
          if (filters.areaName && filters.areaName.trim()) params.set('areaName', filters.areaName.trim());
          if (filters.areaType && filters.areaType.trim()) params.set('areaType', filters.areaType.trim());
          if (filters.active !== 'any') params.set('active', filters.active);
          if (filters.accessible !== 'any') params.set('accessible', filters.accessible);
          if (filters.allGender !== 'any') params.set('allGender', filters.allGender);
          if (filters.radar !== 'any') params.set('radar', filters.radar);
          if (filters.babyChange !== 'any') params.set('babyChange', filters.babyChange);
          if (filters.noPayment !== 'any') params.set('noPayment', filters.noPayment);
          if (filters.verified !== 'any') params.set('verified', filters.verified);
          if (filters.hasLocation !== 'any') params.set('hasLocation', filters.hasLocation);
          if (filters.sort) params.set('sort', filters.sort);
          params.set('limit', String(filters.limit));
          params.set('page', String(filters.page));
          return params.toString();
        };

        const computeReportStats = (reports) => {
          if (!Array.isArray(reports) || reports.length === 0) {
            return {
              total: 0,
              manual: 0,
              system: 0,
              last: null,
              first: null,
              contributors: [],
            };
          }
          let manual = 0;
          let system = 0;
          const contributors = new Set();
          for (const report of reports) {
            if (report && report.isSystemReport) system += 1;
            else manual += 1;
            if (report && report.contributor) contributors.add(report.contributor);
          }
          return {
            total: reports.length,
            manual,
            system,
            last: reports[0] ? reports[0].createdAt || null : null,
            first: reports[reports.length - 1]
              ? reports[reports.length - 1].createdAt || null
              : null,
            contributors: Array.from(contributors),
          };
        };

        const buildEditState = (loo) => ({
          name: loo && loo.name ? loo.name : '',
          notes: loo && loo.notes ? loo.notes : '',
          paymentDetails: loo && loo.paymentDetails ? loo.paymentDetails : '',
          removalReason: loo && loo.removalReason ? loo.removalReason : '',
          active: booleanToOption(loo ? loo.active : null),
          accessible: booleanToOption(loo ? loo.accessible : null),
          allGender: booleanToOption(loo ? loo.allGender : null),
          attended: booleanToOption(loo ? loo.attended : null),
          automatic: booleanToOption(loo ? loo.automatic : null),
          babyChange: booleanToOption(loo ? loo.babyChange : null),
          children: booleanToOption(loo ? loo.children : null),
          men: booleanToOption(loo ? loo.men : null),
          women: booleanToOption(loo ? loo.women : null),
          urinalOnly: booleanToOption(loo ? loo.urinalOnly : null),
          radar: booleanToOption(loo ? loo.radar : null),
          noPayment: booleanToOption(loo ? loo.noPayment : null),
          locationLat:
            loo && loo.location && typeof loo.location.lat === 'number'
              ? loo.location.lat.toFixed(6)
              : '',
          locationLng:
            loo && loo.location && typeof loo.location.lng === 'number'
              ? loo.location.lng.toFixed(6)
              : '',
          locationCleared: false,
        });

        const copyFilters = (filters) => {
          const next = {};
          for (const key in filters) {
            next[key] = filters[key];
          }
          return next;
        };

        const FILTER_SUMMARY_KEYS = [
          'search',
          'areaName',
          'areaType',
          'active',
          'accessible',
          'allGender',
          'radar',
          'babyChange',
          'noPayment',
          'verified',
          'hasLocation',
        ];

        const countActiveFilters = (filters) => {
          let count = 0;
          for (const key of FILTER_SUMMARY_KEYS) {
            if (filters[key] !== DEFAULT_FILTER_TEMPLATE[key]) {
              count += 1;
            }
          }
          return count;
        };

        const areaToString = (area) => {
          if (!Array.isArray(area) || area.length === 0) return '—';
          const names = [];
          for (const item of area) {
            if (item && item.name) names.push(item.name);
            else if (item && item.type) names.push(item.type);
          }
          return names.length > 0 ? names.join(', ') : '—';
        };

        const generateState = () => {
          if (window.crypto && typeof window.crypto.randomUUID === 'function') {
            return window.crypto.randomUUID();
          }
          if (window.crypto && typeof window.crypto.getRandomValues === 'function') {
            const bytes = new Uint32Array(4);
            window.crypto.getRandomValues(bytes);
            return Array.from(bytes)
              .map((value) => value.toString(16).padStart(8, '0'))
              .join('');
          }
          return String(Date.now());
        };
        class AdminHeader extends HTMLElement {
          constructor() {
            super();
            this._ready = false;
            this._pendingUpdate = null;
            this._revealed = false;
            this.signInButton = null;
            this.headerHint = null;
            this.tokenInput = null;
            this.toggleButton = null;
            this.clearButton = null;
            this.tokenHint = null;
            this.flashEl = null;
          }

          connectedCallback() {
            if (this._ready) return;
            this.classList.add('panel', 'surface');
            this.innerHTML =
              '<div class="header">' +
              '  <div>' +
              '    <h1 class="header__title">Toilet Data Explorer</h1>' +
              '    <p class="header__subtitle">Inspect toilet records, explore verification history, and publish updates with fast filters and map context.</p>' +
              '    <span class="header__badge">Admin workspace</span>' +
              '  </div>' +
              '  <div class="header__actions">' +
              '    <div class="header__oauth">' +
              '      <button type="button" class="btn btn-primary header__signin">Sign in with Auth0</button>' +
              '      <span class="header__hint">Opens Auth0 to mint an access token for editing.</span>' +
              '    </div>' +
              '    <div class="header__token">' +
              '      <label class="field-label" for="admin-token-input">Bearer token</label>' +
              '      <div class="token-control">' +
              '        <input id="admin-token-input" name="token" type="password" placeholder="Paste Auth0 token for admin API" autocomplete="off" />' +
              '        <button type="button" class="btn btn-ghost token-toggle">Show</button>' +
              '        <button type="button" class="btn btn-ghost token-clear">Clear</button>' +
              '      </div>' +
              '      <span class="header__token-hint">Paste a token to enable editing.</span>' +
              '    </div>' +
              '  </div>' +
              '</div>' +
              '<div class="header__flash info" hidden></div>';

            this.signInButton = this.querySelector('.header__signin');
            this.headerHint = this.querySelector('.header__hint');
            this.tokenInput = this.querySelector('#admin-token-input');
            this.toggleButton = this.querySelector('.token-toggle');
            this.clearButton = this.querySelector('.token-clear');
            this.tokenHint = this.querySelector('.header__token-hint');
            this.flashEl = this.querySelector('.header__flash');

            if (this.tokenInput) {
              this.tokenInput.addEventListener('input', () => {
                this.dispatchEvent(
                  new CustomEvent('token-change', {
                    detail: { token: this.tokenInput.value },
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            if (this.toggleButton) {
              this.toggleButton.addEventListener('click', () => {
                this._revealed = !this._revealed;
                if (this.tokenInput) {
                  this.tokenInput.type = this._revealed ? 'text' : 'password';
                }
                this.updateToggleLabel();
              });
            }

            if (this.clearButton) {
              this.clearButton.addEventListener('click', () => {
                this.dispatchEvent(
                  new CustomEvent('clear-token', {
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            if (this.signInButton) {
              this.signInButton.addEventListener('click', () => {
                this.dispatchEvent(
                  new CustomEvent('request-auth', {
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            this._ready = true;
            if (this._pendingUpdate) {
              this.update(this._pendingUpdate);
              this._pendingUpdate = null;
            }
          }

          updateToggleLabel() {
            if (this.toggleButton) {
              this.toggleButton.textContent = this._revealed ? 'Hide' : 'Show';
            }
          }

          update(payload) {
            if (!this._ready) {
              this._pendingUpdate = payload;
              return;
            }
            const token = payload && payload.token ? payload.token : '';
            if (this.tokenInput && this.tokenInput.value !== token) {
              this.tokenInput.value = token;
            }
            if (this.clearButton) {
              this.clearButton.disabled = token.length === 0;
            }
            if (this.tokenHint) {
              this.tokenHint.textContent =
                token.length > 0
                  ? 'Token stored locally for this browser.'
                  : 'Paste a token from Auth0 to enable editing.';
            }
            this._revealed = this._revealed && token.length > 0;
            if (this.tokenInput) {
              this.tokenInput.type = this._revealed ? 'text' : 'password';
            }
            this.updateToggleLabel();

            const auth = payload && payload.auth ? payload.auth : { enabled: false };
            if (this.signInButton) {
              this.signInButton.hidden = !auth.enabled;
              this.signInButton.disabled = auth.loading === true;
            }
            if (this.headerHint) {
              this.headerHint.textContent = auth.enabled
                ? 'Opens Auth0 to mint an access token for editing.'
                : 'Set AUTH0_DATA_EXPLORER_* environment variables to enable sign-in.';
            }

            const flash = payload ? payload.flash : null;
            if (this.flashEl) {
              if (flash && flash.message) {
                this.flashEl.textContent = flash.message;
                this.flashEl.className =
                  'header__flash ' + (flash.type ? flash.type : 'info');
                this.flashEl.hidden = false;
              } else {
                this.flashEl.hidden = true;
              }
            }
          }
        }
        class FilterPanel extends HTMLElement {
          constructor() {
            super();
            this._ready = false;
            this._pendingUpdate = null;
            this.inputs = {};
            this.summaryEl = null;
            this.resetButton = null;
            this.applyButton = null;
            this.formEl = null;
          }

          connectedCallback() {
            if (this._ready) return;
            this.classList.add('panel', 'surface');
            const header = document.createElement('div');
            header.className = 'panel__header';

            const headerText = document.createElement('div');
            const title = document.createElement('h2');
            title.className = 'panel__title';
            title.textContent = 'Filter records';
            headerText.appendChild(title);
            const description = document.createElement('p');
            description.className = 'panel__description';
            description.textContent =
              'Combine filters to narrow the dataset. Apply updates to refresh the results and map.';
            headerText.appendChild(description);
            this.summaryEl = document.createElement('p');
            this.summaryEl.className = 'panel__summary';
            this.summaryEl.textContent = 'All records';
            headerText.appendChild(this.summaryEl);
            header.appendChild(headerText);

            const actions = document.createElement('div');
            actions.className = 'panel__actions';
            this.resetButton = document.createElement('button');
            this.resetButton.type = 'button';
            this.resetButton.className = 'btn btn-ghost';
            this.resetButton.textContent = 'Reset';
            actions.appendChild(this.resetButton);
            this.applyButton = document.createElement('button');
            this.applyButton.type = 'button';
            this.applyButton.className = 'btn btn-primary';
            this.applyButton.textContent = 'Apply filters';
            actions.appendChild(this.applyButton);
            header.appendChild(actions);

            this.appendChild(header);

            const form = document.createElement('form');
            form.className = 'filters-form';
            form.setAttribute('autocomplete', 'off');
            form.addEventListener('submit', (event) => {
              event.preventDefault();
            });

            const searchFieldset = document.createElement('fieldset');
            const searchLegend = document.createElement('legend');
            searchLegend.textContent = 'Search';
            searchFieldset.appendChild(searchLegend);

            const searchGroup = document.createElement('div');
            searchGroup.className = 'field-group';
            const searchLabel = document.createElement('label');
            searchLabel.className = 'field-label';
            searchLabel.setAttribute('for', 'filter-search');
            searchLabel.textContent = 'Keywords';
            searchGroup.appendChild(searchLabel);
            const searchInput = document.createElement('input');
            searchInput.id = 'filter-search';
            searchInput.name = 'search';
            searchInput.type = 'search';
            searchInput.placeholder = 'ID, name, geohash, notes';
            searchInput.autocomplete = 'off';
            searchGroup.appendChild(searchInput);
            this.inputs.search = searchInput;
            searchFieldset.appendChild(searchGroup);

            const searchGrid = document.createElement('div');
            searchGrid.className = 'field-grid field-grid--two';

            const areaNameGroup = document.createElement('div');
            areaNameGroup.className = 'field-group';
            const areaNameLabel = document.createElement('label');
            areaNameLabel.className = 'field-label';
            areaNameLabel.setAttribute('for', 'filter-area-name');
            areaNameLabel.textContent = 'Area name';
            areaNameGroup.appendChild(areaNameLabel);
            const areaNameInput = document.createElement('input');
            areaNameInput.id = 'filter-area-name';
            areaNameInput.name = 'areaName';
            areaNameInput.type = 'search';
            areaNameInput.placeholder = 'e.g. Westminster';
            areaNameGroup.appendChild(areaNameInput);
            this.inputs.areaName = areaNameInput;
            searchGrid.appendChild(areaNameGroup);

            const areaTypeGroup = document.createElement('div');
            areaTypeGroup.className = 'field-group';
            const areaTypeLabel = document.createElement('label');
            areaTypeLabel.className = 'field-label';
            areaTypeLabel.setAttribute('for', 'filter-area-type');
            areaTypeLabel.textContent = 'Area type';
            areaTypeGroup.appendChild(areaTypeLabel);
            const areaTypeInput = document.createElement('input');
            areaTypeInput.id = 'filter-area-type';
            areaTypeInput.name = 'areaType';
            areaTypeInput.type = 'search';
            areaTypeInput.placeholder = 'e.g. borough';
            areaTypeGroup.appendChild(areaTypeInput);
            this.inputs.areaType = areaTypeInput;
            searchGrid.appendChild(areaTypeGroup);

            searchFieldset.appendChild(searchGrid);
            form.appendChild(searchFieldset);

            const statusFieldset = document.createElement('fieldset');
            const statusLegend = document.createElement('legend');
            statusLegend.textContent = 'Status and amenities';
            statusFieldset.appendChild(statusLegend);

            const statusGrid = document.createElement('div');
            statusGrid.className = 'field-grid field-grid--two';
            const statusFields = [
              { name: 'active', label: 'Active status', options: TRI_STATE_FILTER_OPTIONS },
              { name: 'accessible', label: 'Accessible', options: TRI_STATE_FILTER_OPTIONS },
              { name: 'allGender', label: 'All gender', options: TRI_STATE_FILTER_OPTIONS },
              { name: 'radar', label: 'RADAR key', options: TRI_STATE_FILTER_OPTIONS },
              { name: 'babyChange', label: 'Baby change', options: TRI_STATE_FILTER_OPTIONS },
              { name: 'noPayment', label: 'No payment', options: TRI_STATE_FILTER_OPTIONS },
              { name: 'verified', label: 'Verified', options: BOOLEAN_FILTER_OPTIONS },
              { name: 'hasLocation', label: 'Has location', options: BOOLEAN_FILTER_OPTIONS },
            ];
            for (const field of statusFields) {
              const group = document.createElement('div');
              group.className = 'field-group';
              const label = document.createElement('label');
              label.className = 'field-label';
              label.setAttribute('for', 'filter-' + field.name);
              label.textContent = field.label;
              group.appendChild(label);
              const select = document.createElement('select');
              select.id = 'filter-' + field.name;
              select.name = field.name;
              for (const option of field.options) {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;
                select.appendChild(opt);
              }
              group.appendChild(select);
              this.inputs[field.name] = select;
              statusGrid.appendChild(group);
            }
            statusFieldset.appendChild(statusGrid);
            form.appendChild(statusFieldset);

            const resultFieldset = document.createElement('fieldset');
            const resultLegend = document.createElement('legend');
            resultLegend.textContent = 'Result preferences';
            resultFieldset.appendChild(resultLegend);

            const resultGrid = document.createElement('div');
            resultGrid.className = 'field-grid field-grid--two';

            const sortGroup = document.createElement('div');
            sortGroup.className = 'field-group';
            const sortLabel = document.createElement('label');
            sortLabel.className = 'field-label';
            sortLabel.setAttribute('for', 'filter-sort');
            sortLabel.textContent = 'Sort by';
            sortGroup.appendChild(sortLabel);
            const sortSelect = document.createElement('select');
            sortSelect.id = 'filter-sort';
            sortSelect.name = 'sort';
            for (const option of SORT_OPTIONS) {
              const opt = document.createElement('option');
              opt.value = option.value;
              opt.textContent = option.label;
              sortSelect.appendChild(opt);
            }
            sortGroup.appendChild(sortSelect);
            this.inputs.sort = sortSelect;
            resultGrid.appendChild(sortGroup);

            const limitGroup = document.createElement('div');
            limitGroup.className = 'field-group';
            const limitLabel = document.createElement('label');
            limitLabel.className = 'field-label';
            limitLabel.setAttribute('for', 'filter-limit');
            limitLabel.textContent = 'Results per page';
            limitGroup.appendChild(limitLabel);
            const limitSelect = document.createElement('select');
            limitSelect.id = 'filter-limit';
            limitSelect.name = 'limit';
            for (const size of PAGE_SIZE_OPTIONS) {
              const opt = document.createElement('option');
              opt.value = String(size);
              opt.textContent = String(size);
              limitSelect.appendChild(opt);
            }
            limitGroup.appendChild(limitSelect);
            this.inputs.limit = limitSelect;
            resultGrid.appendChild(limitGroup);

            resultFieldset.appendChild(resultGrid);
            form.appendChild(resultFieldset);

            this.formEl = form;
            this.appendChild(form);

            const handleField = (event) => {
              const target = event.target;
              if (!target || !target.name) {
                return;
              }
              if (
                target.tagName !== 'INPUT' &&
                target.tagName !== 'SELECT' &&
                target.tagName !== 'TEXTAREA'
              ) {
                return;
              }
              this.dispatchEvent(
                new CustomEvent('filters-change', {
                  detail: { field: target.name, value: target.value },
                  bubbles: true,
                  composed: true,
                }),
              );
            };

            form.addEventListener('input', handleField);
            form.addEventListener('change', handleField);

            if (this.applyButton) {
              this.applyButton.addEventListener('click', () => {
                this.dispatchEvent(
                  new CustomEvent('filters-apply', {
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            if (this.resetButton) {
              this.resetButton.addEventListener('click', () => {
                this.dispatchEvent(
                  new CustomEvent('filters-reset', {
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            this._ready = true;
            if (this._pendingUpdate) {
              this.update(this._pendingUpdate);
              this._pendingUpdate = null;
            }
          }

          update(payload) {
            if (!this._ready) {
              this._pendingUpdate = payload;
              return;
            }
            const filters = payload && payload.filters ? payload.filters : createDefaultFilters();
            for (const key in this.inputs) {
              const input = this.inputs[key];
              if (!input) continue;
              let value = filters[key];
              if (typeof value === 'number') {
                value = String(value);
              }
              if (value === undefined || value === null) {
                value = '';
              }
              if (input.value !== value) {
                input.value = value;
              }
            }
            if (this.summaryEl) {
              this.summaryEl.textContent = payload && payload.summary ? payload.summary : 'All records';
            }
            if (this.applyButton) {
              const loading = payload && payload.loading;
              this.applyButton.disabled = Boolean(loading);
              this.applyButton.textContent = loading ? 'Loading…' : 'Apply filters';
            }
            if (this.resetButton) {
              this.resetButton.disabled = !(payload && payload.changed);
            }
          }
        }

        class ResultsPanel extends HTMLElement {
          constructor() {
            super();
            this._ready = false;
            this._pendingUpdate = null;
            this.currentData = [];
            this.summaryEl = null;
            this.prevButton = null;
            this.nextButton = null;
            this.paginationStatus = null;
            this.tableWrapper = null;
            this.tbody = null;
            this.emptyState = null;
            this.errorState = null;
            this.errorMessage = null;
            this.retryButton = null;
          }

          connectedCallback() {
            if (this._ready) return;
            this.classList.add('panel', 'surface');
            this.innerHTML =
              '<div class="panel__header">' +
              '  <div>' +
              '    <h2 class="panel__title">Results</h2>' +
              '    <p class="panel__description">Matches for the active filters. Select a row to view details.</p>' +
              '  </div>' +
              '  <div class="results-meta">' +
              '    <span class="results-summary">Awaiting search</span>' +
              '    <div class="pagination-controls">' +
              '      <button type="button" class="btn btn-ghost pagination-prev">Previous</button>' +
              '      <span class="pagination-status">Page 1</span>' +
              '      <button type="button" class="btn btn-ghost pagination-next">Next</button>' +
              '    </div>' +
              '  </div>' +
              '</div>' +
              '<div class="panel__body">' +
              '  <div class="table-scroll">' +
              '    <table class="results-table">' +
              '      <thead>' +
              '        <tr>' +
              '          <th>ID</th>' +
              '          <th>Name</th>' +
              '          <th>Active</th>' +
              '          <th>Accessible</th>' +
              '          <th>Area</th>' +
              '          <th>Updated</th>' +
              '          <th>Verified</th>' +
              '        </tr>' +
              '      </thead>' +
              '      <tbody></tbody>' +
              '    </table>' +
              '  </div>' +
              '  <div class="results-status results-empty" hidden>' +
              '    <strong>No results yet</strong>' +
              '    <span>Adjust your filters and apply to load data.</span>' +
              '  </div>' +
              '  <div class="results-status results-error" hidden>' +
              '    <strong>Unable to load data</strong>' +
              '    <span class="results-error-message"></span>' +
              '    <div style="margin-top:12px;">' +
              '      <button type="button" class="btn btn-ghost results-retry">Retry search</button>' +
              '    </div>' +
              '  </div>' +
              '</div>';

            this.summaryEl = this.querySelector('.results-summary');
            this.prevButton = this.querySelector('.pagination-prev');
            this.nextButton = this.querySelector('.pagination-next');
            this.paginationStatus = this.querySelector('.pagination-status');
            this.tableWrapper = this.querySelector('.table-scroll');
            this.tbody = this.querySelector('tbody');
            this.emptyState = this.querySelector('.results-empty');
            this.errorState = this.querySelector('.results-error');
            this.errorMessage = this.querySelector('.results-error-message');
            this.retryButton = this.querySelector('.results-retry');

            if (this.prevButton) {
              this.prevButton.addEventListener('click', () => {
                this.dispatchEvent(
                  new CustomEvent('paginate', {
                    detail: { direction: 'previous' },
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            if (this.nextButton) {
              this.nextButton.addEventListener('click', () => {
                this.dispatchEvent(
                  new CustomEvent('paginate', {
                    detail: { direction: 'next' },
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            if (this.retryButton) {
              this.retryButton.addEventListener('click', () => {
                this.dispatchEvent(
                  new CustomEvent('retry-search', {
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            if (this.tbody) {
              this.tbody.addEventListener('click', (event) => {
                const target = event.target;
                const row = target && target.closest ? target.closest('tr.result-row') : null;
                if (!row) return;
                const index = row.dataset.index ? Number(row.dataset.index) : -1;
                if (index >= 0 && index < this.currentData.length) {
                  const record = this.currentData[index];
                  this.dispatchEvent(
                    new CustomEvent('select-record', {
                      detail: { record },
                      bubbles: true,
                      composed: true,
                    }),
                  );
                }
              });
            }

            this._ready = true;
            if (this._pendingUpdate) {
              this.update(this._pendingUpdate);
              this._pendingUpdate = null;
            }
          }

          update(payload) {
            if (!this._ready) {
              this._pendingUpdate = payload;
              return;
            }
            const results = payload && payload.results ? payload.results : {
              loading: false,
              error: null,
              data: [],
              total: 0,
              page: 1,
              pageSize: 50,
              hasMore: false,
            };
            const selectedId = payload && payload.selectedId ? payload.selectedId : null;
            this.currentData = Array.isArray(results.data) ? results.data : [];

            const loading = !!results.loading;
            const error = results.error ? String(results.error) : null;

            if (this.summaryEl) {
              if (error) {
                this.summaryEl.textContent = 'Unable to load records';
              } else if (loading && this.currentData.length === 0) {
                this.summaryEl.textContent = 'Loading records…';
              } else {
                const count = this.currentData.length;
                if (count === 0) {
                  this.summaryEl.textContent = 'No records on this page';
                } else {
                  const page = results.page || 1;
                  const pageSize = results.pageSize || count;
                  const start = (page - 1) * pageSize + 1;
                  const end = start + count - 1;
                  if (results.total && results.total >= end) {
                    this.summaryEl.textContent =
                      'Showing ' + start + ' – ' + end + ' of ' + results.total;
                  } else {
                    this.summaryEl.textContent = 'Showing ' + count + ' results';
                  }
                }
              }
            }

            const hasRows = this.currentData.length > 0;
            if (this.tableWrapper) {
              this.tableWrapper.hidden = !hasRows || !!error;
            }
            if (this.emptyState) {
              if (loading && !hasRows) {
                this.emptyState.hidden = false;
                const strong = this.emptyState.querySelector('strong');
                const span = this.emptyState.querySelector('span');
                if (strong) strong.textContent = 'Loading records…';
                if (span) span.textContent = 'Fetching loos that match your filters.';
              } else if (!hasRows && !error) {
                this.emptyState.hidden = false;
                const strong = this.emptyState.querySelector('strong');
                const span = this.emptyState.querySelector('span');
                if (strong) strong.textContent = 'No matches found';
                if (span) span.textContent = 'Try widening or clearing your filters.';
              } else {
                this.emptyState.hidden = true;
              }
            }
            if (this.errorState) {
              this.errorState.hidden = !error;
              if (error && this.errorMessage) {
                this.errorMessage.textContent = error;
              }
            }

            if (this.tbody && hasRows && !error) {
              this.tbody.innerHTML = '';
              for (let index = 0; index < this.currentData.length; index += 1) {
                const item = this.currentData[index];
                const row = document.createElement('tr');
                row.className = 'result-row';
                if (item && item.id === selectedId) {
                  row.classList.add('selected');
                }
                row.dataset.index = String(index);

                const idCell = document.createElement('td');
                const idCode = document.createElement('code');
                idCode.textContent = item && item.id ? item.id : '—';
                idCell.appendChild(idCode);
                row.appendChild(idCell);

                const nameCell = document.createElement('td');
                nameCell.textContent = item && item.name ? item.name : '—';
                row.appendChild(nameCell);

                const activeCell = document.createElement('td');
                activeCell.textContent = formatFlag(item ? item.active : null);
                row.appendChild(activeCell);

                const accessibleCell = document.createElement('td');
                accessibleCell.textContent = formatFlag(item ? item.accessible : null);
                row.appendChild(accessibleCell);

                const areaCell = document.createElement('td');
                areaCell.textContent = areaToString(item ? item.area : null);
                row.appendChild(areaCell);

                const updatedCell = document.createElement('td');
                const updatedRelative = document.createElement('div');
                updatedRelative.textContent = formatRelative(item ? item.updatedAt : null);
                const updatedExact = document.createElement('div');
                updatedExact.style.opacity = '0.65';
                updatedExact.style.fontSize = '0.78rem';
                updatedExact.textContent = formatDateTime(item ? item.updatedAt : null);
                updatedCell.appendChild(updatedRelative);
                updatedCell.appendChild(updatedExact);
                row.appendChild(updatedCell);

                const verifiedCell = document.createElement('td');
                verifiedCell.textContent = formatDateTime(item ? item.verifiedAt : null);
                row.appendChild(verifiedCell);

                this.tbody.appendChild(row);
              }
            } else if (this.tbody && (!hasRows || error)) {
              this.tbody.innerHTML = '';
            }

            const total = results.total || 0;
            const page = results.page || 1;
            const pageSize = results.pageSize || 50;
            const hasMore = !!results.hasMore;
            const totalPages =
              total > 0 && pageSize > 0 ? Math.max(1, Math.ceil(total / pageSize)) : null;

            if (this.paginationStatus) {
              if (error) {
                this.paginationStatus.textContent = 'Page ' + page;
              } else if (totalPages) {
                this.paginationStatus.textContent = 'Page ' + page + ' of ' + totalPages;
              } else if (hasMore) {
                this.paginationStatus.textContent = 'Page ' + page + ' of ?';
              } else {
                this.paginationStatus.textContent = 'Page ' + page;
              }
            }

            const canGoPrev = page > 1;
            const canGoNext = hasMore || (totalPages !== null && page < totalPages);

            if (this.prevButton) {
              this.prevButton.disabled = loading || !canGoPrev;
            }
            if (this.nextButton) {
              this.nextButton.disabled = loading || !canGoNext;
            }
          }
        }
        class MapPanel extends HTMLElement {
          constructor() {
            super();
            this._ready = false;
            this._pendingUpdate = null;
            this._map = null;
            this._layer = null;
            this._signature = '';
            this.currentData = [];
            this.mapContainer = null;
            this.mapHint = null;
            this.noticeEl = null;
          }

          connectedCallback() {
            if (this._ready) return;
            this.classList.add('panel', 'surface');
            const header = document.createElement('div');
            header.className = 'panel__header';
            const headerTitleWrap = document.createElement('div');
            const title = document.createElement('h2');
            title.className = 'panel__title';
            title.textContent = 'Map overview';
            headerTitleWrap.appendChild(title);
            const description = document.createElement('p');
            description.className = 'panel__description';
            description.textContent =
              'Markers reflect results on the current page. Click a marker to select a loo or click the map to update the location.';
            headerTitleWrap.appendChild(description);
            header.appendChild(headerTitleWrap);

            const actions = document.createElement('div');
            actions.className = 'panel__actions';
            const resetButton = document.createElement('button');
            resetButton.type = 'button';
            resetButton.className = 'btn btn-ghost';
            resetButton.textContent = 'Reset view';
            actions.appendChild(resetButton);
            header.appendChild(actions);
            this.appendChild(header);

            const wrapper = document.createElement('div');
            wrapper.className = 'map-wrapper';
            this.mapContainer = document.createElement('div');
            this.mapContainer.className = 'map-container';
            wrapper.appendChild(this.mapContainer);
            this.mapHint = document.createElement('p');
            this.mapHint.className = 'map-hint';
            this.mapHint.textContent = 'Tip: click a location on the map to populate latitude and longitude fields.';
            wrapper.appendChild(this.mapHint);
            this.noticeEl = document.createElement('div');
            this.noticeEl.className = 'results-status';
            this.noticeEl.style.display = 'none';
            this.noticeEl.innerHTML =
              '<strong>No markers yet</strong><span>Apply filters to load results and show them on the map.</span>';
            wrapper.appendChild(this.noticeEl);
            this.appendChild(wrapper);

            resetButton.addEventListener('click', () => {
              this.resetView();
            });

            this._ready = true;
            if (this._pendingUpdate) {
              this.update(this._pendingUpdate);
              this._pendingUpdate = null;
            }
          }

          ensureMap() {
            if (this._map || !this.mapContainer) return;
            if (!window.L) {
              return;
            }
            this._map = window.L.map(this.mapContainer, {
              center: [54.5, -2.2],
              zoom: 6,
              minZoom: 3,
            });
            window.L
              .tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors',
              })
              .addTo(this._map);
            this._layer = window.L.layerGroup().addTo(this._map);
            this._map.on('click', (event) => {
              const latlng = event.latlng || {};
              if (typeof latlng.lat === 'number' && typeof latlng.lng === 'number') {
                this.dispatchEvent(
                  new CustomEvent('map-location-selected', {
                    detail: { lat: latlng.lat, lng: latlng.lng },
                    bubbles: true,
                    composed: true,
                  }),
                );
              }
            });
            setTimeout(() => {
              if (this._map) {
                this._map.invalidateSize();
              }
            }, 100);
          }

          resetView() {
            if (this._map) {
              this._map.setView([54.5, -2.2], 6);
            }
          }

          updateMarkers(selectedId) {
            if (!this._map || !this._layer) return;
            this._layer.clearLayers();
            const bounds = [];
            for (const item of this.currentData) {
              if (!item || !item.location) continue;
              const lat = item.location.lat;
              const lng = item.location.lng;
              if (typeof lat !== 'number' || typeof lng !== 'number') continue;
              const marker = window.L.circleMarker([lat, lng], {
                radius: item.id === selectedId ? 9 : 7,
                color: item.id === selectedId ? '#f97316' : '#2563eb',
                weight: item.id === selectedId ? 4 : 2,
                opacity: 0.9,
                fillColor: item.id === selectedId ? '#fb923c' : '#60a5fa',
                fillOpacity: 0.65,
              });
              marker.on('click', () => {
                this.dispatchEvent(
                  new CustomEvent('select-record', {
                    detail: { record: item },
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
              marker.addTo(this._layer);
              bounds.push([lat, lng]);
            }
            const signature = bounds.map((coords) => coords.join(',')).join('|');
            if (bounds.length > 0) {
              if (this._signature !== signature) {
                this._map.fitBounds(bounds, { padding: [36, 36], maxZoom: 16 });
                this._signature = signature;
              }
            } else {
              this._signature = '';
              this.resetView();
            }
          }

          update(payload) {
            if (!this._ready) {
              this._pendingUpdate = payload;
              return;
            }
            this.currentData = payload && Array.isArray(payload.results) ? payload.results : [];
            const selectedId = payload && payload.selectedId ? payload.selectedId : null;
            if (!window.L) {
              if (this.noticeEl) {
                this.noticeEl.style.display = 'block';
                this.noticeEl.innerHTML =
                  '<strong>Map unavailable</strong><span>Leaflet failed to load. Refresh the page to retry.</span>';
              }
              return;
            }
            this.ensureMap();
            if (!this._map) {
              return;
            }
            if (this.noticeEl) {
              if (this.currentData.length === 0) {
                this.noticeEl.style.display = 'block';
                this.noticeEl.innerHTML =
                  '<strong>No markers yet</strong><span>Apply filters to load results and show them on the map.</span>';
              } else {
                this.noticeEl.style.display = 'none';
              }
            }
            this.updateMarkers(selectedId);
          }
        }

        class DetailPanel extends HTMLElement {
          constructor() {
            super();
            this._ready = false;
            this._pendingUpdate = null;
            this.titleEl = null;
            this.subtitleEl = null;
            this.badgesEl = null;
            this.bodyEl = null;
            this.emptyStateEl = null;
            this.contentEl = null;
            this.metaList = null;
            this.metaArea = null;
            this.metaCreated = null;
            this.metaUpdated = null;
            this.metaVerified = null;
            this.metaLastReport = null;
            this.metaLocation = null;
            this.tagsEl = null;
            this.notesContainer = null;
            this.reportsSection = null;
            this.reportsStatus = null;
            this.reportsMetaGrid = null;
            this.reportTotal = null;
            this.reportSplit = null;
            this.reportLast = null;
            this.reportFirst = null;
            this.reportContributors = null;
            this.reportsList = null;
            this.editSection = null;
            this.editForm = null;
            this.saveStatus = null;
            this.saveButton = null;
            this.clearLocationButton = null;
            this.inputs = {};
          }

          connectedCallback() {
            if (this._ready) return;
            this.classList.add('panel', 'surface');
            const header = document.createElement('div');
            header.className = 'panel__header detail__header';

            const headerText = document.createElement('div');
            this.titleEl = document.createElement('h2');
            this.titleEl.className = 'panel__title';
            this.titleEl.textContent = 'Details & reports';
            headerText.appendChild(this.titleEl);
            this.subtitleEl = document.createElement('p');
            this.subtitleEl.className = 'detail__subtitle';
            this.subtitleEl.textContent = 'Select a record to inspect full details.';
            headerText.appendChild(this.subtitleEl);
            header.appendChild(headerText);

            this.badgesEl = document.createElement('div');
            this.badgesEl.className = 'detail__badges';
            header.appendChild(this.badgesEl);
            this.appendChild(header);

            this.bodyEl = document.createElement('div');
            this.bodyEl.className = 'detail__body';

            this.emptyStateEl = document.createElement('div');
            this.emptyStateEl.className = 'results-status';
            this.emptyStateEl.innerHTML =
              '<strong>No loo selected</strong><span>Choose a record from the table or map to view its metadata and reports.</span>';
            this.bodyEl.appendChild(this.emptyStateEl);

            this.contentEl = document.createElement('div');
            this.contentEl.className = 'detail__content';
            this.contentEl.hidden = true;

            this.metaList = document.createElement('dl');
            this.metaList.className = 'detail__meta';
            this.metaArea = this.appendMetaItem('Area');
            this.metaCreated = this.appendMetaItem('Created');
            this.metaUpdated = this.appendMetaItem('Updated');
            this.metaVerified = this.appendMetaItem('Verified');
            this.metaLastReport = this.appendMetaItem('Last report');
            this.metaLocation = this.appendMetaItem('Location');
            this.contentEl.appendChild(this.metaList);

            this.tagsEl = document.createElement('div');
            this.tagsEl.className = 'detail__tags';
            this.contentEl.appendChild(this.tagsEl);

            this.notesContainer = document.createElement('div');
            this.notesContainer.className = 'detail__notes';
            this.contentEl.appendChild(this.notesContainer);

            this.reportsSection = document.createElement('section');
            this.reportsSection.className = 'detail__reports';
            const reportsHeader = document.createElement('h3');
            reportsHeader.className = 'panel__title';
            reportsHeader.style.fontSize = '1rem';
            reportsHeader.textContent = 'Report insights';
            this.reportsSection.appendChild(reportsHeader);
            this.reportsStatus = document.createElement('div');
            this.reportsStatus.className = 'reports-empty';
            this.reportsStatus.hidden = true;
            this.reportsSection.appendChild(this.reportsStatus);
            this.reportsMetaGrid = document.createElement('div');
            this.reportsMetaGrid.className = 'reports-grid';
            this.reportTotal = this.appendReportItem('Total reports');
            this.reportSplit = this.appendReportItem('Manual vs system');
            this.reportLast = this.appendReportItem('Last update');
            this.reportFirst = this.appendReportItem('First record');
            this.reportContributors = this.appendReportItem('Contributors');
            this.reportsSection.appendChild(this.reportsMetaGrid);
            this.reportsList = document.createElement('div');
            this.reportsList.className = 'reports-list';
            this.reportsSection.appendChild(this.reportsList);
            this.contentEl.appendChild(this.reportsSection);

            this.editSection = document.createElement('section');
            this.editSection.className = 'detail__editor';
            const editHeader = document.createElement('h3');
            editHeader.className = 'panel__title';
            editHeader.style.fontSize = '1rem';
            editHeader.textContent = 'Edit loo';
            this.editSection.appendChild(editHeader);

            this.saveStatus = document.createElement('div');
            this.saveStatus.className = 'status-message';
            this.saveStatus.hidden = true;
            this.editSection.appendChild(this.saveStatus);

            this.editForm = document.createElement('form');
            this.editForm.className = 'edit-form';
            this.editForm.addEventListener('submit', (event) => {
              event.preventDefault();
            });

            const textFields = [
              { name: 'name', label: 'Name', type: 'input' },
              { name: 'notes', label: 'Notes', type: 'textarea' },
              { name: 'paymentDetails', label: 'Payment details', type: 'textarea' },
              { name: 'removalReason', label: 'Removal reason', type: 'textarea' },
            ];
            for (const field of textFields) {
              const group = document.createElement('div');
              group.className = 'field-group';
              const label = document.createElement('label');
              label.className = 'field-label';
              label.textContent = field.label;
              group.appendChild(label);
              let control;
              if (field.type === 'textarea') {
                control = document.createElement('textarea');
              } else {
                control = document.createElement('input');
                control.type = 'text';
              }
              control.name = field.name;
              control.dataset.field = field.name;
              group.appendChild(control);
              this.inputs[field.name] = control;
              this.editForm.appendChild(group);
            }

            const flagGroup = document.createElement('div');
            flagGroup.className = 'field-grid field-grid--three';
            const flagFields = [
              'active',
              'accessible',
              'allGender',
              'attended',
              'automatic',
              'babyChange',
              'children',
              'men',
              'women',
              'urinalOnly',
              'radar',
              'noPayment',
            ];
            for (const name of flagFields) {
              const group = document.createElement('div');
              group.className = 'field-group';
              const label = document.createElement('label');
              label.className = 'field-label';
              label.textContent = name.replace(/([A-Z])/g, ' $1').replace(/^\w/, (c) => c.toUpperCase());
              group.appendChild(label);
              const select = document.createElement('select');
              select.name = name;
              select.dataset.field = name;
              for (const option of TRI_STATE_FILTER_OPTIONS) {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;
                select.appendChild(opt);
              }
              group.appendChild(select);
              this.inputs[name] = select;
              flagGroup.appendChild(group);
            }
            this.editForm.appendChild(flagGroup);

            const locationGroup = document.createElement('div');
            locationGroup.className = 'field-group';
            const locationLabel = document.createElement('label');
            locationLabel.className = 'field-label';
            locationLabel.textContent = 'Location (click map to populate)';
            locationGroup.appendChild(locationLabel);
            const locationGrid = document.createElement('div');
            locationGrid.className = 'location-grid';
            const latInput = document.createElement('input');
            latInput.type = 'text';
            latInput.placeholder = 'Latitude';
            latInput.name = 'locationLat';
            latInput.dataset.field = 'locationLat';
            locationGrid.appendChild(latInput);
            const lngInput = document.createElement('input');
            lngInput.type = 'text';
            lngInput.placeholder = 'Longitude';
            lngInput.name = 'locationLng';
            lngInput.dataset.field = 'locationLng';
            locationGrid.appendChild(lngInput);
            this.inputs.locationLat = latInput;
            this.inputs.locationLng = lngInput;
            locationGroup.appendChild(locationGrid);
            this.clearLocationButton = document.createElement('button');
            this.clearLocationButton.type = 'button';
            this.clearLocationButton.className = 'btn btn-secondary';
            this.clearLocationButton.textContent = 'Clear location';
            this.clearLocationButton.style.width = 'max-content';
            locationGroup.appendChild(this.clearLocationButton);
            this.editForm.appendChild(locationGroup);

            const actionRow = document.createElement('div');
            actionRow.className = 'detail__actions';
            this.saveButton = document.createElement('button');
            this.saveButton.type = 'submit';
            this.saveButton.className = 'btn btn-primary';
            this.saveButton.textContent = 'Save changes';
            actionRow.appendChild(this.saveButton);
            this.editForm.appendChild(actionRow);

            this.editSection.appendChild(this.editForm);
            this.contentEl.appendChild(this.editSection);

            this.bodyEl.appendChild(this.contentEl);
            this.appendChild(this.bodyEl);

            for (const key in this.inputs) {
              const input = this.inputs[key];
              const handler = () => {
                this.dispatchEvent(
                  new CustomEvent('edit-change', {
                    detail: { field: key, value: input.value },
                    bubbles: true,
                    composed: true,
                  }),
                );
              };
              if (input.tagName === 'SELECT') {
                input.addEventListener('change', handler);
              } else {
                input.addEventListener('input', handler);
              }
            }

            if (this.clearLocationButton) {
              this.clearLocationButton.addEventListener('click', () => {
                this.dispatchEvent(
                  new CustomEvent('clear-location', {
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            if (this.saveButton) {
              this.saveButton.addEventListener('click', (event) => {
                event.preventDefault();
                this.dispatchEvent(
                  new CustomEvent('save-requested', {
                    bubbles: true,
                    composed: true,
                  }),
                );
              });
            }

            this._ready = true;
            if (this._pendingUpdate) {
              this.update(this._pendingUpdate);
              this._pendingUpdate = null;
            }
          }

          appendMetaItem(label) {
            const wrapper = document.createElement('div');
            const dt = document.createElement('dt');
            dt.textContent = label;
            const dd = document.createElement('dd');
            dd.textContent = '—';
            wrapper.appendChild(dt);
            wrapper.appendChild(dd);
            this.metaList.appendChild(wrapper);
            return dd;
          }

          appendReportItem(label) {
            const wrapper = document.createElement('span');
            const title = document.createElement('strong');
            title.textContent = label;
            const value = document.createElement('span');
            value.textContent = '—';
            wrapper.appendChild(title);
            wrapper.appendChild(value);
            this.reportsMetaGrid.appendChild(wrapper);
            return value;
          }

          setFormDisabled(disabled) {
            for (const key in this.inputs) {
              const input = this.inputs[key];
              if (input) {
                input.disabled = disabled;
              }
            }
            if (this.saveButton) {
              this.saveButton.disabled = disabled;
            }
            if (this.clearLocationButton) {
              this.clearLocationButton.disabled = disabled;
            }
          }

          update(payload) {
            if (!this._ready) {
              this._pendingUpdate = payload;
              return;
            }
            const selected = payload ? payload.selected : null;
            const editState = payload ? payload.editState : null;
            const reports = payload ? payload.reports : { loading: false, error: null, records: [], stats: computeReportStats([]) };
            const saveState = payload ? payload.saveState : { status: 'idle', message: '' };
            const tokenPresent = payload ? payload.tokenPresent : false;

            if (!selected) {
              this.emptyStateEl.hidden = false;
              this.contentEl.hidden = true;
              this.titleEl.textContent = 'Details & reports';
              this.subtitleEl.textContent = 'Select a record to inspect full details.';
              this.badgesEl.innerHTML = '';
              this.setFormDisabled(true);
              return;
            }

            this.emptyStateEl.hidden = true;
            this.contentEl.hidden = false;
            this.setFormDisabled(false);

            this.titleEl.textContent = selected.name ? selected.name : 'Unnamed toilet';
            this.subtitleEl.textContent = 'ID ' + (selected.id || '—');

            this.badgesEl.innerHTML = '';
            const statusChip = document.createElement('span');
            if (selected.active === false) {
              statusChip.className = 'chip chip--neutral';
              statusChip.textContent = 'Inactive';
            } else {
              statusChip.className = 'chip chip--success';
              statusChip.textContent = selected.active === true ? 'Active' : 'Status unknown';
            }
            this.badgesEl.appendChild(statusChip);
            if (selected.verifiedAt) {
              const verifiedChip = document.createElement('span');
              verifiedChip.className = 'chip';
              verifiedChip.textContent = 'Verified ' + formatRelative(selected.verifiedAt);
              this.badgesEl.appendChild(verifiedChip);
            }

            this.metaArea.textContent = areaToString(selected.area);
            this.metaCreated.textContent = formatDateTime(selected.createdAt);
            this.metaUpdated.textContent = formatDateTime(selected.updatedAt);
            this.metaVerified.textContent = formatDateTime(selected.verifiedAt);
            if (reports && reports.stats && reports.stats.last) {
              this.metaLastReport.textContent = formatDateTime(reports.stats.last);
            } else {
              this.metaLastReport.textContent = '—';
            }
            if (selected.location && typeof selected.location.lat === 'number' && typeof selected.location.lng === 'number') {
              this.metaLocation.textContent =
                selected.location.lat.toFixed(6) + ', ' + selected.location.lng.toFixed(6);
            } else {
              this.metaLocation.textContent = 'Not set';
            }

            this.tagsEl.innerHTML = '';
            const tagFields = [
              { key: 'accessible', label: 'Accessible' },
              { key: 'allGender', label: 'All gender' },
              { key: 'babyChange', label: 'Baby change' },
              { key: 'radar', label: 'RADAR key' },
              { key: 'noPayment', label: 'Free' },
              { key: 'attended', label: 'Attended' },
              { key: 'automatic', label: 'Automatic' },
              { key: 'children', label: 'Children' },
              { key: 'men', label: 'Men' },
              { key: 'women', label: 'Women' },
              { key: 'urinalOnly', label: 'Urinal only' },
            ];
            for (const tag of tagFields) {
              if (selected[tag.key] === true) {
                const chip = document.createElement('span');
                chip.className = 'chip';
                chip.textContent = tag.label;
                this.tagsEl.appendChild(chip);
              }
            }
            if (!this.tagsEl.hasChildNodes()) {
              const chip = document.createElement('span');
              chip.className = 'chip chip--neutral';
              chip.textContent = 'No amenities recorded';
              this.tagsEl.appendChild(chip);
            }

            this.notesContainer.innerHTML = '';
            const appendNote = (label, value) => {
              if (!value) return;
              const note = document.createElement('div');
              note.className = 'detail-note';
              const heading = document.createElement('h3');
              heading.textContent = label;
              note.appendChild(heading);
              const paragraph = document.createElement('p');
              paragraph.textContent = value;
              note.appendChild(paragraph);
              this.notesContainer.appendChild(note);
            };
            appendNote('Notes', selected.notes);
            appendNote('Payment details', selected.paymentDetails);
            appendNote('Removal reason', selected.removalReason);
            if (!this.notesContainer.hasChildNodes()) {
              const note = document.createElement('div');
              note.className = 'detail-note';
              const heading = document.createElement('h3');
              heading.textContent = 'Notes';
              note.appendChild(heading);
              const paragraph = document.createElement('p');
              paragraph.textContent =
                'No notes have been recorded yet. Add context before publishing changes.';
              note.appendChild(paragraph);
              this.notesContainer.appendChild(note);
            }

            if (reports.loading) {
              this.reportsStatus.hidden = false;
              this.reportsStatus.className = 'reports-empty';
              this.reportsStatus.textContent = 'Loading reports…';
              this.reportsMetaGrid.style.display = 'none';
              this.reportsList.style.display = 'none';
            } else if (reports.error) {
              this.reportsStatus.hidden = false;
              this.reportsStatus.className = 'reports-error';
              this.reportsStatus.textContent = String(reports.error);
              this.reportsMetaGrid.style.display = 'none';
              this.reportsList.style.display = 'none';
            } else {
              this.reportsStatus.hidden = true;
              this.reportsMetaGrid.style.display = '';
              this.reportsList.style.display = '';
              const stats = reports.stats || computeReportStats(reports.records);
              this.reportTotal.textContent = String(stats.total);
              this.reportSplit.textContent = stats.manual + ' manual · ' + stats.system + ' system';
              this.reportLast.textContent = formatDateTime(stats.last);
              this.reportFirst.textContent = formatDateTime(stats.first);
              this.reportContributors.textContent =
                stats.contributors && stats.contributors.length > 0
                  ? stats.contributors.join(', ')
                  : '—';
              this.reportsList.innerHTML = '';
              if (reports.records && reports.records.length > 0) {
                const slice = reports.records.slice(0, 6);
                for (const record of slice) {
                  const item = document.createElement('div');
                  item.className = 'reports-item';
                  const header = document.createElement('div');
                  header.className = 'reports-item__header';
                  const contributor = document.createElement('span');
                  contributor.textContent = record && record.contributor ? record.contributor : 'Unknown';
                  header.appendChild(contributor);
                  const age = document.createElement('span');
                  age.textContent = formatRelative(record ? record.createdAt : null);
                  header.appendChild(age);
                  item.appendChild(header);
                  const meta = document.createElement('div');
                  meta.className = 'reports-item__meta';
                  meta.textContent =
                    formatDateTime(record ? record.createdAt : null) +
                    (record && record.isSystemReport ? ' · system' : '');
                  item.appendChild(meta);
                  const content = document.createElement('div');
                  content.style.fontSize = '0.85rem';
                  content.textContent =
                    'Active: ' +
                    formatFlag(record ? record.active : null) +
                    ' · Accessible: ' +
                    formatFlag(record ? record.accessible : null);
                  item.appendChild(content);
                  this.reportsList.appendChild(item);
                }
              } else {
                this.reportsStatus.hidden = false;
                this.reportsStatus.className = 'reports-empty';
                this.reportsStatus.textContent = 'No reports have been logged yet.';
                this.reportsMetaGrid.style.display = 'none';
                this.reportsList.style.display = 'none';
              }
            }

            if (editState) {
              for (const key in this.inputs) {
                const input = this.inputs[key];
                if (!input) continue;
                const nextValue =
                  editState[key] !== undefined && editState[key] !== null
                    ? String(editState[key])
                    : '';
                if (input.value !== nextValue) {
                  input.value = nextValue;
                }
              }
            }

            if (this.saveButton) {
              if (!tokenPresent) {
                this.saveButton.disabled = true;
                this.saveButton.title = 'Add an Auth0 bearer token to enable editing.';
                this.saveButton.textContent = 'Save changes';
              } else if (saveState && saveState.status === 'saving') {
                this.saveButton.disabled = true;
                this.saveButton.textContent = 'Saving…';
                this.saveButton.title = '';
              } else {
                this.saveButton.disabled = false;
                this.saveButton.textContent = 'Save changes';
                this.saveButton.title = '';
              }
            }

            if (this.saveStatus) {
              if (saveState && saveState.status && saveState.status !== 'idle') {
                this.saveStatus.hidden = false;
                this.saveStatus.className =
                  'status-message ' +
                  (saveState.status === 'success'
                    ? 'success'
                    : saveState.status === 'error'
                    ? 'error'
                    : '');
                this.saveStatus.textContent =
                  saveState.message || (saveState.status === 'success'
                    ? 'Changes saved successfully.'
                    : '');
              } else {
                this.saveStatus.hidden = true;
              }
            }
          }
        }
        class AdminApp extends HTMLElement {
          constructor() {
            super();
            const defaults = createDefaultFilters();
            this.state = {
              formFilters: defaults,
              appliedFilters: copyFilters(defaults),
              results: {
                loading: false,
                error: null,
                data: [],
                total: 0,
                page: 1,
                pageSize: defaults.limit,
                hasMore: false,
              },
              selected: null,
              reports: {
                loading: false,
                error: null,
                records: [],
                stats: computeReportStats([]),
              },
              edit: null,
              token: '',
              saveState: { status: 'idle', message: '' },
              flash: null,
            };
            this._connected = false;
            this._searchController = null;
            this._reportsController = null;
            this._flashTimeout = null;
            this._auth0Config = null;
            this.headerEl = null;
            this.filterPanel = null;
            this.resultsPanel = null;
            this.mapPanel = null;
            this.detailPanel = null;
          }

          connectedCallback() {
            if (this._connected) return;
            this._connected = true;
            this.classList.add('admin-app');
            this.buildLayout();
            this.attachEvents();
            this.restoreToken();
            this.captureOAuthResponse();
            this.render();
            this.loadResults();
          }

          getAuth0Config() {
            if (this._auth0Config) {
              return this._auth0Config;
            }
            const data = this.dataset || {};
            const config = {
              enabled:
                data.auth0Enabled === 'true' &&
                !!data.auth0AuthorizeUrl &&
                !!data.auth0ClientId &&
                !!data.auth0Audience,
              authorizeUrl: data.auth0AuthorizeUrl || '',
              clientId: data.auth0ClientId || '',
              audience: data.auth0Audience || '',
              scope: data.auth0Scope || 'openid profile email offline_access',
              redirectUri: data.auth0RedirectUri || '',
            };
            this._auth0Config = config;
            return config;
          }

          buildLayout() {
            this.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'admin-app';

            this.headerEl = document.createElement('tm-admin-header');
            container.appendChild(this.headerEl);

            const main = document.createElement('main');
            main.className = 'admin-shell';

            this.filterPanel = document.createElement('tm-filter-panel');
            main.appendChild(this.filterPanel);

            const workspace = document.createElement('section');
            workspace.className = 'workspace';

            this.resultsPanel = document.createElement('tm-results-panel');
            workspace.appendChild(this.resultsPanel);

            const split = document.createElement('div');
            split.className = 'split-layout';
            this.mapPanel = document.createElement('tm-map-panel');
            split.appendChild(this.mapPanel);
            this.detailPanel = document.createElement('tm-detail-panel');
            split.appendChild(this.detailPanel);
            workspace.appendChild(split);

            main.appendChild(workspace);
            container.appendChild(main);

            const footer = document.createElement('footer');
            footer.className = 'admin-footer';
            footer.textContent =
              'Built for internal use. Map updates populate coordinates, and editing requires an Auth0 bearer token.';
            container.appendChild(footer);

            this.appendChild(container);
          }

          attachEvents() {
            this.addEventListener('token-change', (event) => {
              const detail = event.detail || {};
              const token = detail.token !== undefined ? detail.token : '';
              this.setToken(token);
            });

            this.addEventListener('clear-token', () => {
              this.setToken('');
              this.setFlash('Token cleared from this browser.', 'info');
            });

            this.addEventListener('request-auth', () => {
              this.startOAuthFlow();
            });

            this.addEventListener('filters-change', (event) => {
              const detail = event.detail || {};
              if (!detail.field) return;
              this.handleFilterChange(detail.field, detail.value);
            });

            this.addEventListener('filters-apply', () => {
              this.applyFilters();
            });

            this.addEventListener('filters-reset', () => {
              this.resetFilters();
            });

            this.addEventListener('paginate', (event) => {
              const detail = event.detail || {};
              this.handlePaginate(detail.direction);
            });

            this.addEventListener('retry-search', () => {
              this.loadResults();
            });

            this.addEventListener('select-record', (event) => {
              const detail = event.detail || {};
              this.handleSelect(detail);
            });

            this.addEventListener('map-location-selected', (event) => {
              const detail = event.detail || {};
              this.handleMapLocation(detail);
            });

            this.addEventListener('edit-change', (event) => {
              const detail = event.detail || {};
              this.handleEditChange(detail);
            });

            this.addEventListener('clear-location', () => {
              this.handleClearLocation();
            });

            this.addEventListener('save-requested', () => {
              this.handleSave();
            });
          }

          restoreToken() {
            try {
              const stored = window.localStorage.getItem(STORAGE_KEY);
              if (stored) {
                this.state.token = stored;
              }
            } catch (error) {
              // ignore
            }
          }

          captureOAuthResponse() {
            const hash = window.location.hash || '';
            if (hash.length <= 1) {
              return;
            }
            const params = new URLSearchParams(hash.slice(1));
            const accessToken = params.get('access_token');
            const error = params.get('error');
            const errorDescription = params.get('error_description');
            const returnedState = params.get('state');

            if (accessToken) {
              let valid = true;
              try {
                const storedState = window.sessionStorage.getItem(AUTH_STATE_STORAGE_KEY);
                if (storedState && returnedState && storedState !== returnedState) {
                  valid = false;
                  this.setFlash('Auth0 response state mismatch. Token discarded.', 'error');
                }
                window.sessionStorage.removeItem(AUTH_STATE_STORAGE_KEY);
              } catch (err) {
                // ignore
              }
              if (valid) {
                this.setToken(accessToken);
                this.setFlash('Signed in with Auth0. Token stored locally.', 'success');
              }
            } else if (error) {
              const message = errorDescription ? errorDescription : error;
              this.setFlash('Auth0 sign-in failed: ' + message, 'error');
            }

            if (accessToken || error) {
              const newUrl =
                window.location.origin +
                window.location.pathname +
                window.location.search;
              window.history.replaceState(null, document.title, newUrl);
            }
          }

          setToken(token) {
            this.state.token = token || '';
            try {
              if (this.state.token) {
                window.localStorage.setItem(STORAGE_KEY, this.state.token);
              } else {
                window.localStorage.removeItem(STORAGE_KEY);
              }
            } catch (error) {
              // ignore storage errors
            }
            if (this.state.saveState.status !== 'idle') {
              this.state.saveState = { status: 'idle', message: '' };
            }
            this.render();
          }

          setFlash(message, type) {
            this.state.flash = message
              ? { message: String(message), type: type || 'info' }
              : null;
            this.render();
            if (this._flashTimeout) {
              clearTimeout(this._flashTimeout);
            }
            if (message) {
              this._flashTimeout = window.setTimeout(() => {
                this.state.flash = null;
                this.render();
              }, 6000);
            }
          }

          handleFilterChange(field, rawValue) {
            const value = rawValue !== undefined && rawValue !== null ? String(rawValue) : '';
            const current = copyFilters(this.state.formFilters);
            if (field === 'limit') {
              const parsed = Number(value);
              current.limit = Number.isFinite(parsed) && parsed > 0 ? parsed : DEFAULT_FILTER_TEMPLATE.limit;
              current.page = 1;
            } else if (field in current) {
              current[field] = value;
            }
            this.state.formFilters = current;
            this.render();
          }

          applyFilters() {
            const next = copyFilters(this.state.formFilters);
            next.page = 1;
            this.state.formFilters = next;
            this.state.appliedFilters = copyFilters(next);
            this.loadResults();
          }

          resetFilters() {
            const defaults = createDefaultFilters();
            this.state.formFilters = defaults;
            this.state.appliedFilters = copyFilters(defaults);
            this.state.selected = null;
            this.state.edit = null;
            this.state.reports = {
              loading: false,
              error: null,
              records: [],
              stats: computeReportStats([]),
            };
            this.state.saveState = { status: 'idle', message: '' };
            this.render();
            this.loadResults();
          }

          handlePaginate(direction) {
            if (!direction) return;
            const current = copyFilters(this.state.appliedFilters);
            if (direction === 'next') {
              current.page += 1;
            } else if (direction === 'previous') {
              current.page = Math.max(1, current.page - 1);
            }
            this.state.appliedFilters = current;
            const form = copyFilters(this.state.formFilters);
            form.page = current.page;
            this.state.formFilters = form;
            this.loadResults();
          }

          handleSelect(detail) {
            let record = detail && detail.record ? detail.record : null;
            if (!record && detail && detail.id) {
              record = (this.state.results.data || []).find((item) => item && item.id === detail.id) || null;
            }
            if (!record) return;
            this.state.selected = record;
            this.state.edit = buildEditState(record);
            this.state.saveState = { status: 'idle', message: '' };
            this.state.reports = {
              loading: true,
              error: null,
              records: [],
              stats: computeReportStats([]),
            };
            this.render();
            this.loadReports(record.id);
          }

          handleMapLocation(detail) {
            if (!this.state.edit) return;
            const lat = detail && typeof detail.lat === 'number' ? detail.lat : null;
            const lng = detail && typeof detail.lng === 'number' ? detail.lng : null;
            if (lat === null || lng === null) return;
            const next = Object.assign({}, this.state.edit);
            next.locationLat = lat.toFixed(6);
            next.locationLng = lng.toFixed(6);
            next.locationCleared = false;
            this.state.edit = next;
            this.state.saveState = { status: 'idle', message: '' };
            this.render();
          }

          handleEditChange(detail) {
            if (!this.state.edit || !detail || !detail.field) return;
            const next = Object.assign({}, this.state.edit);
            next[detail.field] = detail.value !== undefined && detail.value !== null ? String(detail.value) : '';
            if (detail.field === 'locationLat' || detail.field === 'locationLng') {
              next.locationCleared = false;
            }
            this.state.edit = next;
            if (this.state.saveState.status !== 'idle') {
              this.state.saveState = { status: 'idle', message: '' };
            }
            this.render();
          }

          handleClearLocation() {
            if (!this.state.edit) return;
            const next = Object.assign({}, this.state.edit);
            next.locationLat = '';
            next.locationLng = '';
            next.locationCleared = true;
            this.state.edit = next;
            if (this.state.saveState.status !== 'idle') {
              this.state.saveState = { status: 'idle', message: '' };
            }
            this.render();
          }

          startOAuthFlow() {
            const config = this.getAuth0Config();
            if (!config.enabled) {
              this.setFlash('Auth0 sign-in is not configured for this environment.', 'error');
              return;
            }
            try {
              const url = new URL(config.authorizeUrl);
              url.searchParams.set('client_id', config.clientId);
              url.searchParams.set('audience', config.audience);
              url.searchParams.set('response_type', 'token');
              url.searchParams.set('scope', config.scope || 'openid profile email offline_access');
              const redirectUri =
                config.redirectUri ||
                window.location.origin + window.location.pathname;
              url.searchParams.set('redirect_uri', redirectUri);
              const state = generateState();
              try {
                window.sessionStorage.setItem(AUTH_STATE_STORAGE_KEY, state);
              } catch (err) {
                // ignore
              }
              url.searchParams.set('state', state);
              url.searchParams.set('prompt', 'login');
              window.location.href = url.toString();
            } catch (error) {
              this.setFlash('Unable to open Auth0 login.', 'error');
            }
          }

          async handleSave() {
            if (!this.state.selected || !this.state.edit) return;
            if (this.state.saveState.status === 'saving') return;
            if (!this.state.token) {
              this.state.saveState = {
                status: 'error',
                message: 'Add an Auth0 bearer token to save changes.',
              };
              this.render();
              return;
            }
            const edit = this.state.edit;
            const payload = {
              name: edit.name && edit.name.trim() ? edit.name.trim() : null,
              notes: edit.notes && edit.notes.trim() ? edit.notes.trim() : null,
              paymentDetails:
                edit.paymentDetails && edit.paymentDetails.trim()
                  ? edit.paymentDetails.trim()
                  : null,
              removalReason:
                edit.removalReason && edit.removalReason.trim()
                  ? edit.removalReason.trim()
                  : null,
              active: optionToBoolean(edit.active),
              accessible: optionToBoolean(edit.accessible),
              allGender: optionToBoolean(edit.allGender),
              attended: optionToBoolean(edit.attended),
              automatic: optionToBoolean(edit.automatic),
              babyChange: optionToBoolean(edit.babyChange),
              children: optionToBoolean(edit.children),
              men: optionToBoolean(edit.men),
              women: optionToBoolean(edit.women),
              urinalOnly: optionToBoolean(edit.urinalOnly),
              radar: optionToBoolean(edit.radar),
              noPayment: optionToBoolean(edit.noPayment),
            };
            if (edit.locationCleared) {
              payload.location = null;
            } else if (edit.locationLat && edit.locationLng) {
              const lat = Number(edit.locationLat);
              const lng = Number(edit.locationLng);
              if (Number.isFinite(lat) && Number.isFinite(lng)) {
                payload.location = { lat, lng };
              } else {
                this.state.saveState = {
                  status: 'error',
                  message: 'Latitude and longitude must be valid numbers.',
                };
                this.render();
                return;
              }
            }

            this.state.saveState = { status: 'saving', message: 'Saving changes…' };
            this.render();

            try {
              const response = await fetch('/loos/' + encodeURIComponent(this.state.selected.id), {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: 'Bearer ' + this.state.token.trim(),
                },
                body: JSON.stringify(payload),
              });
              if (!response.ok) {
                let message = 'Update failed with status ' + response.status;
                try {
                  const body = await response.json();
                  if (body && body.message) {
                    message = body.message;
                  }
                } catch (error) {
                  // ignore
                }
                throw new Error(message);
              }
              this.state.saveState = {
                status: 'success',
                message: 'Changes saved successfully.',
              };
              this.render();
              this.refreshSelected(this.state.selected.id);
            } catch (error) {
              this.state.saveState = {
                status: 'error',
                message: error instanceof Error ? error.message : String(error),
              };
              this.render();
            }
          }

          async refreshSelected(id) {
            try {
              const response = await fetch('/loos/' + encodeURIComponent(id));
              if (!response.ok) return;
              const data = await response.json();
              if (!data) return;
              this.state.selected = data;
              this.state.edit = buildEditState(data);
              const updatedResults = (this.state.results.data || []).map((item) =>
                item && item.id === data.id ? data : item,
              );
              this.state.results = Object.assign({}, this.state.results, {
                data: updatedResults,
              });
              this.render();
            } catch (error) {
              // ignore
            }
          }

          async loadResults() {
            if (this._searchController) {
              this._searchController.abort();
            }
            const controller = new AbortController();
            this._searchController = controller;
            this.state.results = Object.assign({}, this.state.results, {
              loading: true,
              error: null,
            });
            this.render();
            const filters = this.state.appliedFilters;
            const limit = Number(filters.limit);
            if (!Number.isFinite(limit) || limit <= 0) {
              filters.limit = DEFAULT_FILTER_TEMPLATE.limit;
            }
            if (!filters.page || filters.page < 1) {
              filters.page = 1;
            }
            this.state.appliedFilters = filters;
            this.state.formFilters = Object.assign({}, this.state.formFilters, {
              limit: filters.limit,
              page: filters.page,
            });
            try {
              const query = buildSearchParams(filters);
              const response = await fetch('/loos/search?' + query, {
                signal: controller.signal,
              });
              if (!response.ok) {
                let message = 'Search failed with status ' + response.status;
                try {
                  const body = await response.json();
                  if (body && body.message) {
                    message = body.message;
                  }
                } catch (error) {
                  // ignore
                }
                throw new Error(message);
              }
              const payload = await response.json();
              if (controller.signal.aborted) {
                return;
              }
              const data = Array.isArray(payload && payload.data) ? payload.data : [];
              const page = payload && payload.page ? Number(payload.page) : filters.page;
              const pageSize = payload && payload.pageSize ? Number(payload.pageSize) : filters.limit;
              const total =
                payload && payload.total !== undefined
                  ? Number(payload.total)
                  : payload && payload.count !== undefined
                  ? Number(payload.count)
                  : data.length;
              const hasMore =
                payload && payload.hasMore !== undefined
                  ? !!payload.hasMore
                  : data.length === pageSize;
              this.state.results = {
                loading: false,
                error: null,
                data,
                total: Number.isFinite(total) ? total : data.length,
                page: Number.isFinite(page) ? page : filters.page,
                pageSize: Number.isFinite(pageSize) ? pageSize : filters.limit,
                hasMore,
              };
              this.render();
            } catch (error) {
              if (controller.signal.aborted) {
                return;
              }
              this.state.results = {
                loading: false,
                error: error instanceof Error ? error.message : String(error),
                data: [],
                total: 0,
                page: filters.page,
                pageSize: filters.limit,
                hasMore: false,
              };
              this.render();
            } finally {
              this._searchController = null;
            }
          }

          async loadReports(id) {
            if (this._reportsController) {
              this._reportsController.abort();
            }
            const controller = new AbortController();
            this._reportsController = controller;
            this.state.reports = {
              loading: true,
              error: null,
              records: [],
              stats: computeReportStats([]),
            };
            this.render();
            try {
              const response = await fetch('/loos/' + encodeURIComponent(id) + '/reports', {
                signal: controller.signal,
              });
              if (!response.ok) {
                let message = 'Failed to load reports (' + response.status + ')';
                try {
                  const body = await response.json();
                  if (body && body.message) {
                    message = body.message;
                  }
                } catch (error) {
                  // ignore
                }
                throw new Error(message);
              }
              const payload = await response.json();
              if (controller.signal.aborted) {
                return;
              }
              const records = Array.isArray(payload && payload.data) ? payload.data : [];
              this.state.reports = {
                loading: false,
                error: null,
                records,
                stats: computeReportStats(records),
              };
              this.render();
            } catch (error) {
              if (controller.signal.aborted) {
                return;
              }
              this.state.reports = {
                loading: false,
                error: error instanceof Error ? error.message : String(error),
                records: [],
                stats: computeReportStats([]),
              };
              this.render();
            } finally {
              this._reportsController = null;
            }
          }

          render() {
            if (!this.headerEl || !this.filterPanel || !this.resultsPanel || !this.mapPanel || !this.detailPanel) {
              return;
            }
            const activeCount = countActiveFilters(this.state.formFilters);
            const summary =
              activeCount === 0
                ? 'All records'
                : activeCount + ' filter' + (activeCount === 1 ? '' : 's') + ' active';
            const auth = this.getAuth0Config();
            this.headerEl.update({
              token: this.state.token,
              auth: { enabled: auth.enabled, loading: false },
              flash: this.state.flash,
            });
            this.filterPanel.update({
              filters: this.state.formFilters,
              loading: this.state.results.loading,
              summary,
              changed: activeCount > 0,
            });
            this.resultsPanel.update({
              results: this.state.results,
              selectedId: this.state.selected ? this.state.selected.id : null,
            });
            this.mapPanel.update({
              results: this.state.results.data,
              selectedId: this.state.selected ? this.state.selected.id : null,
            });
            this.detailPanel.update({
              selected: this.state.selected,
              editState: this.state.edit,
              reports: this.state.reports,
              saveState: this.state.saveState,
              tokenPresent: !!this.state.token,
            });
          }
        }

        const defineElement = (tag, klass) => {
          if (!customElements.get(tag)) {
            customElements.define(tag, klass);
          }
        };

        defineElement('tm-admin-header', AdminHeader);
        defineElement('tm-filter-panel', FilterPanel);
        defineElement('tm-results-panel', ResultsPanel);
        defineElement('tm-map-panel', MapPanel);
        defineElement('tm-detail-panel', DetailPanel);
        defineElement('tm-admin-app', AdminApp);
      })();
    </script>
  </body>
</html>