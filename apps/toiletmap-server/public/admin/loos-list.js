import{u as S,a as D,b as F,j as e,F as N,r as z}from"./streaming-BQkSWh89.js";function U(t){const[a,l]=S(t);return{state:a,setState:l,updateSearch:u=>{l({...a,search:u,page:1})},updatePage:u=>{l({...a,page:u})},updatePageSize:u=>{l({...a,pageSize:u,page:1})},updateSort:(u,p)=>{l({...a,sortBy:u,sortOrder:p,hasCustomSort:!0})},updateFilter:(u,p)=>{l({...a,filters:{...a.filters,[u]:p},page:1})},resetFilters:()=>{l({...a,filters:{},page:1})}}}const T=t=>["name","updated_at","verified_at","created_at"].indexOf(t)>=0?t:"updated_at",j=(t,a)=>t==="name"?a==="asc"?"name-asc":"name-desc":t==="created_at"?a==="asc"?"created-asc":"created-desc":t==="verified_at"?a==="asc"?"verified-asc":"verified-desc":a==="asc"?"updated-asc":"updated-desc",w=t=>t.hasCustomSort?{column:T(t.sortBy),order:t.sortOrder}:{column:"updated_at",order:"desc"},B=(t,a)=>{const l=new URLSearchParams;t.search&&l.set("search",t.search),l.set("page",String(t.page)),l.set("limit",String(t.pageSize));const s=w(t);return l.set("sort",j(s.column,s.order)),Object.keys(t.filters).forEach(r=>{const i=t.filters[r];if(!i||i==="all")return;const n=a[r];if(!n||!n.mapping)return;const o=n.mapping[i];o&&l.set(n.param,o)}),l},V=(t,a,l)=>{const s=B(t,a);return s.delete("limit"),s.delete("page"),s.set("recentWindowDays",String(l)),s},E=(t,a,l={})=>{const s=new URLSearchParams;t.search&&s.set("search",t.search),t.hasCustomSort&&(s.set("sortBy",t.sortBy),s.set("sortOrder",t.sortOrder)),s.set("pageSize",String(t.pageSize)),s.set("page",String(t.page)),Object.keys(t.filters).forEach(i=>{const n=t.filters[i];n&&n!=="all"&&s.set(i,n)}),Object.keys(l).forEach(i=>{const n=l[i];n==null||n===""?s.delete(i):s.set(i,String(n))});const r=s.toString();return r?a+"?"+r:a};async function M(t,a,l){const s=await fetch(t+"?"+a.toString(),{signal:l});if(!s.ok){const r=await s.text().catch(()=>"");throw new Error(r||"Request failed with "+s.status)}return s.json()}function q({state:t,searchEndpoint:a,metricsEndpoint:l,filterMappings:s,recentWindowDays:r}){const[i,n]=S(null),[o,h]=S(null),[u,p]=S(!0),[c,d]=S(!1),[f,m]=S(null),[g,v]=S(0),y=D(null),A=()=>{v(C=>C+1)};return F(()=>((async()=>{y.current&&y.current.abort();const b=new AbortController;y.current=b,p(!0),d(!1),m(null);try{const _=B(t,s),I=await M(a,_,b.signal);if(b.signal.aborted)return;n(I);try{const x=V(t,s,r),O=await M(l,x,b.signal);b.signal.aborted||h(O)}catch(x){b.signal.aborted||(console.error("Failed to load metrics",x),m("Unable to load metrics right now. Please try refreshing."))}}catch(_){b.signal.aborted||(console.error("Failed to load loos data",_),d(!0))}finally{y.current===b&&(y.current=null),p(!1)}})(),()=>{y.current&&y.current.abort()}),[t,a,l,g]),{searchData:i,metricsData:o,loading:u,error:c,metricsError:f,refetch:A}}const W=new Intl.NumberFormat("en-GB"),P=t=>{if(!t)return"—";const a=new Date(t);return isNaN(a.getTime())?"—":a.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})},R=(t,a)=>a?Math.round(t/a*100):0,L=t=>W.format(t),H=t=>{if(!Array.isArray(t)||t.length===0)return"Hours unknown";const a=t.filter(l=>Array.isArray(l)&&l.length===2&&l[0]&&l[1]);return a.length===t.length&&a.every(l=>l[0]==="00:00"&&l[1]==="00:00")?"Open 24h":a.length>0?"Custom hours":"Hours unknown"},G=t=>t===!0?{label:"Active",tone:"positive"}:t===!1?{label:"Inactive",tone:"negative"}:{label:"Status unknown",tone:"muted"},J=t=>t?`Verified ${P(t)}`:"Awaiting verification",K=t=>t===!0?"Accessible":t===!1?"Limited access":"Unknown",Q=(t,a)=>{const l=[];return t===!0&&l.push("Baby change"),t===!1&&l.push("No baby change"),a===!0&&l.push("RADAR key"),a===!1&&l.push("Open access"),l.length?l.join(" / "):"Details unavailable"},X=t=>t===!0?"Free to use":t===!1?"Paid access":"Unknown";function Y({state:t,onRetry:a}){return t==="loading"?e("div",{class:"table-overlay table-overlay--loading","data-loos-table-loading":!0,role:"status","aria-live":"polite",children:e("div",{class:"loading-indicator",children:[e("span",{class:"loading-spinner","aria-hidden":"true"}),e("p",{children:"Refreshing loos…"})]})}):t==="error"?e("div",{class:"table-overlay","data-loos-table-error":!0,role:"alert",children:[e("i",{class:"fa-solid fa-triangle-exclamation","aria-hidden":"true"}),e("h3",{children:"We couldn’t load the loos right now"}),e("p",{children:"Check your filters or try again."}),a&&e("div",{class:"table-overlay__actions",children:e("button",{type:"button",class:"button","data-loos-retry":!0,onClick:a,children:"Try again"})})]}):t==="empty"?e("div",{class:"table-overlay","data-loos-table-empty":!0,role:"status","aria-live":"polite",children:[e("i",{class:"fa-solid fa-inbox","aria-hidden":"true"}),e("h3",{children:"No results match this filter set"}),e("p",{children:"Try broadening your filters or resetting pagination."})]}):null}function Z({row:t}){const a=typeof t.name=="string"&&t.name?t.name:"Unnamed location",l=Array.isArray(t.area)&&t.area[0]&&typeof t.area[0].name=="string"?t.area[0].name:"Unassigned area",s=typeof t.geohash=="string"?t.geohash:"",r=typeof t.id=="string"?t.id:"",i=typeof t.active=="boolean"?t.active:null,n=typeof t.verified_at=="string"?t.verified_at:typeof t.verifiedAt=="string"?t.verifiedAt:null,o=typeof t.accessible=="boolean"?t.accessible:null,h=typeof t.baby_change=="boolean"?t.baby_change:typeof t.babyChange=="boolean"?t.babyChange:null,u=typeof t.no_payment=="boolean"?t.no_payment:typeof t.noPayment=="boolean"?t.noPayment:null,p=typeof t.radar=="boolean"?t.radar:null,c=typeof t.updated_at=="string"?t.updated_at:typeof t.updatedAt=="string"?t.updatedAt:null,d=typeof t.created_at=="string"?t.created_at:typeof t.createdAt=="string"?t.createdAt:null,f=typeof t.contributorsCount=="number"?t.contributorsCount:typeof t.contributors_count=="number"?t.contributors_count:0,m=H(t.openingTimes||t.opening_times),g=G(i),v=J(n),y=K(o),A=Q(h,p),C=X(u);return e("tr",{children:[e("td",{children:e("div",{class:"table-cell-primary",children:[e("strong",{children:e("a",{href:`/admin/loos/${r}`,style:"color: inherit; text-decoration: none;",children:a})}),e("div",{class:"table-cell-meta",children:[e("span",{children:l}),s&&e("span",{class:"table-cell-subtle",children:s}),e("span",{class:"table-cell-subtle",children:["#",r.slice(-6)]})]}),e("div",{class:"meta-pill-group",children:e("span",{class:"meta-pill",children:m})})]})}),e("td",{children:e("div",{class:"detail-stack",children:[e("span",{class:"status-line",children:[e("span",{class:`status-dot status-dot--${g.tone}`}),g.label]}),e("span",{class:"muted-text",children:v})]})}),e("td",{children:e("div",{class:"detail-stack",children:[e("div",{class:"detail-row",children:[e("span",{class:"detail-label",children:"Access"}),e("span",{class:"detail-value",children:y})]}),e("div",{class:"detail-row",children:[e("span",{class:"detail-label",children:"Facilities"}),e("span",{class:"detail-value",children:A})]})]})}),e("td",{children:e("div",{class:"detail-stack",children:[e("div",{class:"detail-row",children:[e("span",{class:"detail-label",children:"Cost"}),e("span",{class:"detail-value",children:C})]}),e("div",{class:"detail-row",children:[e("span",{class:"detail-label",children:"Contributors"}),e("span",{class:"detail-value",children:L(f)})]})]})}),e("td",{children:e("div",{class:"detail-stack",children:[e("div",{class:"detail-row",children:[e("span",{class:"detail-label",children:"Updated"}),e("span",{class:"detail-value",children:P(c)})]}),e("div",{class:"detail-row",children:[e("span",{class:"detail-label",children:"Created"}),e("span",{class:"detail-value",children:P(d)})]})]})})]})}function ee({searchData:t,loading:a,error:l,onRetry:s}){const r=t&&Array.isArray(t.data)?t.data:[],i=!a&&!l&&r.length===0;let n="data";a?n="loading":l?n="error":i&&(n="empty");const o=["table-shell"];n==="loading"&&o.push("table-shell--loading"),(n==="error"||n==="empty")&&o.push("table-shell--muted");const h=o.join(" ");return e("div",{class:"table-overflow","data-loos-table-root":!0,style:"min-height: 600px;",children:e("div",{class:h,children:[e("table",{class:"data-table","data-loos-table":!0,children:[e("thead",{children:e("tr",{children:[e("th",{children:"Location"}),e("th",{children:"Status"}),e("th",{children:"Access & facilities"}),e("th",{children:"Cost & contributors"}),e("th",{children:"Activity"})]})}),e("tbody",{"data-loos-table-body":!0,children:r.map((u,p)=>e(Z,{row:u},u.id||p))})]}),n!=="data"&&e(Y,{state:n,onRetry:s})]})})}function te({searchData:t,state:a,currentPath:l}){const s=Number(t.total)||0,r=Number(t.page)||a.page,i=Number(t.pageSize)||a.pageSize,n=Array.isArray(t.data)?t.data.length:0,o=Math.max(1,Math.ceil(s/(i||1))),h=s===0?0:(r-1)*i+1,u=s===0?0:h+n-1,p=s===0?"No results to display":`Showing ${h}-${u} of ${L(s)}`,c=r<=1,d=!t.hasMore||r>=o,f=E(a,l,{page:Math.max(1,r-1)}),m=E(a,l,{page:Math.min(o,r+1)});let g;if(s===0)g=e("span",{class:"muted-text",children:"No pages to display"});else{const v=[],y=Math.min(5,o);let A=1;o>5&&(r<=3?A=1:r>=o-2?A=o-4:A=r-2);for(let C=0;C<y;C+=1){const b=A+C,_=b===r;v.push(e("a",{href:E(a,l,{page:b}),class:`pagination-btn${_?" active":""}`,children:b},b))}g=e(N,{children:v})}return e("div",{class:"pagination","data-loos-pagination":!0,children:[e("div",{class:"pagination-info","data-loos-pagination-info":!0,children:p}),e("div",{class:"pagination-controls",children:[e("a",{href:f,class:"pagination-btn","data-loos-prev":!0,style:c?"pointer-events: none; opacity: 0.4;":"",children:e("i",{class:"fa-solid fa-chevron-left","aria-hidden":"true"})}),e("div",{class:"pagination-dynamic","data-loos-page-buttons":!0,children:g}),e("a",{href:m,class:"pagination-btn","data-loos-next":!0,style:d?"pointer-events: none; opacity: 0.4;":"",children:e("i",{class:"fa-solid fa-chevron-right","aria-hidden":"true"})})]})]})}function ae({metrics:t,totalCount:a,loading:l}){if(l)return e("div",{"data-loos-features-loading":!0,children:e("p",{children:"Loading features..."})});const s=t.totals||{},r=[{label:"Baby changing",value:s.babyChange||0},{label:"RADAR key",value:s.radar||0},{label:"Free to use",value:s.freeAccess||0},{label:"Verified",value:s.verified||0}];return e("ul",{class:"stat-progress-list","data-loos-feature-list":!0,children:r.map(i=>{const n=R(i.value,a);return e("li",{class:"stat-progress-item",children:[e("div",{class:"stat-progress",children:[e("span",{children:i.label}),e("span",{children:L(i.value)})]}),e("div",{class:"stat-progress-bar",children:e("div",{class:"stat-progress-bar__fill",style:`width: ${n}%`})}),e("span",{class:"stat-progress-meta",children:[n,"% of filtered set"]})]},i.label)})})}function se({metrics:t,areaColors:a,loading:l}){if(l)return e("div",{"data-loos-areas-loading":!0,children:e("p",{children:"Loading areas..."})});const s=Array.isArray(t.areas)?t.areas:[];return s.length===0?e("ul",{"data-loos-area-list":!0,children:e("li",{class:"stat-list-item",children:e("span",{class:"stat-list-label muted-text",children:"No areas match the current filters."})})}):e("ul",{class:"stat-list","data-loos-area-list":!0,children:s.map((r,i)=>{const n=a[i%a.length]||"#0a165e";return e("li",{class:"stat-list-item",children:[e("span",{class:"stat-list-label",children:[e("span",{class:"status-dot",style:`background: ${n};`}),r.name||"Unnamed area"]}),e("strong",{children:L(r.count||0)})]},r.name||i)})})}function le({metrics:t,totalCount:a,searchQuery:l,recentWindowDays:s,areaColors:r,loading:i,error:n}){if(n)return e("div",{children:[e("div",{"data-loos-insights":!0,children:e("div",{class:"metric-card metric-card--error",children:[e("p",{class:"metric-label",children:"Metrics unavailable"}),e("p",{class:"metric-meta",children:n})]})}),e("div",{children:[e("h3",{children:"Features"}),e("ul",{"data-loos-feature-list":!0,children:e("li",{class:"stat-progress-item",children:e("span",{class:"muted-text",children:n})})})]}),e("div",{children:[e("h3",{children:"Areas"}),e("ul",{"data-loos-area-list":!0,children:e("li",{class:"stat-list-item",children:e("span",{class:"stat-list-label muted-text",children:n})})})]})]});if(!t)return null;const o=l?`Matching "${l}"`:"Full dataset slice",h=t.totals||{},u=[{title:"Filtered records",value:a,meta:o},{title:"Active coverage",value:h.active||0,meta:`${R(h.active||0,a)}% active`},{title:"Accessibility ready",value:h.accessible||0,meta:`${R(h.accessible||0,a)}% accessible`},{title:`Updated last ${s}d`,value:h.recent||0,meta:h.recent?"Recently edited":"Needs attention"}],[p,c]=S(!0),d=()=>c(!p);return e("section",{class:`stats-panel ${p?"stats-panel--collapsed":""}`,"data-loos-metrics":!0,children:[e("div",{class:"stats-panel__header",children:[e("div",{class:"stats-summary",children:p?e("span",{children:[L(a)," loos • ",L(h.active||0)," active • ",L(h.accessible||0)," accessible"]}):e("span",{children:"Dataset Insights"})}),e("button",{type:"button",class:"stats-toggle",onClick:d,children:p?e(N,{children:[e("i",{class:"fa-solid fa-chart-simple","aria-hidden":"true"}),e("span",{children:"Show insights"})]}):e(N,{children:[e("i",{class:"fa-solid fa-chevron-up","aria-hidden":"true"}),e("span",{children:"Hide insights"})]})})]}),e("div",{class:"stats-panel__content",children:[e("div",{class:"metric-grid","data-loos-insights":!0,children:u.map(f=>e("div",{class:"metric-card",children:[e("p",{class:"metric-label",children:f.title}),e("p",{class:"metric-value",children:L(f.value)}),e("p",{class:"metric-meta",children:f.meta})]},f.title))}),e("div",{class:"stat-sections",children:[e("div",{class:"stat-section",children:[e("p",{class:"stat-heading",children:"Feature coverage"}),e(ae,{metrics:t,totalCount:a,loading:i})]}),e("div",{class:"stat-section",children:[e("p",{class:"stat-heading",children:"Top areas"}),e(se,{metrics:t,areaColors:r,loading:i})]})]})]})]})}const $=[{key:"status",label:"Status",options:[{value:"all",label:"Any status"},{value:"active",label:"Active only"},{value:"inactive",label:"Inactive only"}]},{key:"access",label:"Accessibility",options:[{value:"all",label:"All toilets"},{value:"accessible",label:"Accessible"},{value:"not_accessible",label:"Not accessible"}]},{key:"payment",label:"Payment",options:[{value:"all",label:"Free & paid"},{value:"free",label:"Free to use"},{value:"paid",label:"Requires payment"}]},{key:"verification",label:"Verification",options:[{value:"all",label:"Any verification state"},{value:"verified",label:"Verified"},{value:"unverified",label:"Awaiting verification"}]}];function ne({state:t,onSearchChange:a,onFilterChange:l,onRefresh:s,loading:r,onResetFilters:i}){const[n,o]=S(t.search);F(()=>{o(t.search)},[t.search]),F(()=>{const c=setTimeout(()=>{n!==t.search&&a(n)},350);return()=>clearTimeout(c)},[n,t.search,a]);const h=c=>{const d=c.target;o(d.value)},u=()=>{o(""),a("")},p=$.map(c=>{const d=t.filters[c.key];if(!d||d==="all")return null;const f=c.options.find(m=>m.value===d);return{key:c.key,label:c.label,value:d,valueLabel:f?.label??d}}).filter(Boolean);return e("section",{class:"table-controls",children:[e("div",{class:"table-controls__row",children:[e("div",{class:"search-form",children:e("div",{class:"search-form__row",children:[e("div",{class:"search-input-wrapper",children:[e("label",{class:"visually-hidden",for:"loos-search",children:"Search"}),e("input",{id:"loos-search",type:"text",class:"input search-input",placeholder:"Search by name, notes, geohash, or area",value:n,onInput:h,autocomplete:"off"}),e("i",{class:"fa-solid fa-magnifying-glass search-input-icon","aria-hidden":"true"}),n&&e("button",{type:"button",class:"search-clear-btn",onClick:u,"aria-label":"Clear search",children:e("i",{class:"fa-solid fa-xmark","aria-hidden":"true"})})]}),e("div",{class:"filter-controls",role:"group","aria-label":"Filters",children:$.map(c=>e("div",{class:"filter-select-wrapper",children:[e("label",{class:"visually-hidden",for:`filter-${c.key}`,children:c.label}),e("select",{id:`filter-${c.key}`,class:"input filter-select",value:t.filters[c.key]||"all",onChange:d=>{const f=d.target;l(c.key,f.value)},children:c.options.map(d=>e("option",{value:d.value,selected:t.filters[c.key]===d.value,children:d.label}))})]}))})]})}),e("button",{type:"button",class:"button button--secondary",onClick:s,disabled:r,style:"height: 42px; margin-top: var(--space-3xs);",children:[e("i",{class:"fa-solid fa-rotate","aria-hidden":"true"}),e("span",{style:"margin-left: var(--space-3xs);",children:"Refresh"})]})]}),p.length>0&&e("div",{class:"active-filters",children:[p.map(c=>e("div",{class:"filter-chip",children:[e("span",{class:"filter-chip__label",children:[c.label,": ",c.valueLabel]}),e("button",{type:"button",class:"filter-chip__remove","aria-label":`Remove filter ${c.label}`,onClick:()=>l(c.key,"all"),children:e("i",{class:"fa-solid fa-xmark","aria-hidden":"true"})})]})),e("button",{type:"button",class:"filter-chip filter-chip--reset",onClick:i,children:[e("i",{class:"fa-solid fa-rotate","aria-hidden":"true"}),e("span",{class:"filter-chip__label",children:"Reset filters"})]})]})]})}const k=t=>typeof t=="object"&&t!==null;function re(){const[t,a]=S(null);return F(()=>{if(typeof window>"u")return;const l=document.getElementById("loos-page-config");if(!l){console.error("Config element not found");return}let s={};try{const g=l.textContent||"{}";s=JSON.parse(g)}catch(g){console.error("Failed to parse loos page config",g);return}const r=k(s.query)?s.query:{},i=k(r.filters)?r.filters:{},n={};Object.keys(i).forEach(g=>{const v=i[g];typeof v=="string"&&(n[g]=v)});const o={search:typeof r.search=="string"?r.search:"",page:Number(r.page)||1,pageSize:Number(r.pageSize)||25,sortBy:typeof r.sortBy=="string"?r.sortBy:"updated_at",sortOrder:r.sortOrder==="asc"?"asc":"desc",hasCustomSort:!!r.hasCustomSort,filters:n},h=k(s.filterMappings)?s.filterMappings:{},u=Array.isArray(s.areaColors)?s.areaColors.filter(g=>typeof g=="string"):[],p=Number(s.recentWindowDays)||14,c=typeof s.currentPath=="string"?s.currentPath:window.location.pathname,d=k(s.api)?s.api:{},f=typeof d.search=="string"?d.search:"/api/loos/search",m=typeof d.metrics=="string"?d.metrics:"/api/loos/metrics";a({filterMappings:h,areaColors:u,recentWindowDays:p,currentPath:c,searchEndpoint:f,metricsEndpoint:m,initialState:o})},[]),t?e(ie,{filterMappings:t.filterMappings,areaColors:t.areaColors,recentWindowDays:t.recentWindowDays,currentPath:t.currentPath,searchEndpoint:t.searchEndpoint,metricsEndpoint:t.metricsEndpoint,initialState:t.initialState}):e("div",{children:"Loading configuration..."})}function ie({filterMappings:t,areaColors:a,recentWindowDays:l,currentPath:s,searchEndpoint:r,metricsEndpoint:i,initialState:n}){const{state:o,updateSearch:h,updateFilter:u,resetFilters:p}=U(n),{searchData:c,metricsData:d,loading:f,error:m,metricsError:g,refetch:v}=q({state:o,searchEndpoint:r,metricsEndpoint:i,filterMappings:t,recentWindowDays:l});return e("div",{children:[e(le,{metrics:d,totalCount:c?.total||0,searchQuery:o.search,recentWindowDays:l,areaColors:a,loading:f,error:g||void 0}),e(ne,{state:o,onSearchChange:h,onFilterChange:u,onRefresh:v,loading:f,onResetFilters:p}),e("section",{class:"table-section",children:[e(ee,{searchData:c,loading:f,error:m,onRetry:v}),c&&e(te,{searchData:c,state:o,currentPath:s})]})]})}const ce=()=>{["[data-loos-metrics]","[data-loos-table-loading]","[data-loos-features-loading]","[data-loos-areas-loading]","[data-loos-pagination]"].forEach(a=>{document.querySelectorAll(a).forEach(s=>{s.style.display="none"})})};if(typeof window<"u"){const t=()=>{ce();const a=document.getElementById("loos-app-root");a?z(e(re,{}),a):console.error("Root element #loos-app-root not found")};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}
//# sourceMappingURL=loos-list.js.map
