{"version":3,"file":"loos-edit.js","sources":["../../src/admin/pages/loos/edit/client/hooks/usePageConfig.ts","../../src/admin/pages/loos/edit/client/EditLooApp.client.tsx","../../src/admin/pages/loos/edit/client/index.client.tsx"],"sourcesContent":["/** @jsxImportSource hono/jsx/dom */\n\nimport { useState, useEffect } from 'hono/jsx';\nimport type { EditPageConfig } from '../utils/types';\n\nconst parseConfig = (scriptId: string): EditPageConfig | null => {\n    if (typeof document === 'undefined') return null;\n\n    const script = document.getElementById(scriptId);\n    if (!script) {\n        console.error(`Config script with id \"${scriptId}\" not found`);\n        return null;\n    }\n\n    const content = script.textContent ?? '';\n    if (!content.trim()) {\n        console.error(`Config script with id \"${scriptId}\" is empty`);\n        return null;\n    }\n\n    try {\n        return JSON.parse(content) as EditPageConfig;\n    } catch (error) {\n        console.error(`Failed to parse config from script \"${scriptId}\"`, error);\n        return null;\n    }\n};\n\n/**\n * Hook to load the edit page config from the server-rendered script tag.\n */\nexport const usePageConfig = () => {\n    const [config, setConfig] = useState<EditPageConfig | null>(null);\n\n    useEffect(() => {\n        const parsed = parseConfig('loo-edit-config');\n        setConfig(parsed);\n    }, []);\n\n    return config;\n};\n","/** @jsxImportSource hono/jsx/dom */\n\nimport { useState, useEffect } from 'hono/jsx';\nimport { LooForm } from '../../shared/LooForm.client';\nimport { usePageConfig } from './hooks/usePageConfig';\nimport { useLooForm } from '../../shared/hooks/useLooForm';\nimport { buildPayload, validateForm } from '../../shared/utils/form';\nimport type { FieldErrors, SubmissionStatus, TriStateValue } from '../../shared/utils/types';\nimport type { EditPageConfig } from './utils/types';\n\nconst mapIssueObject = (issues: unknown): FieldErrors => {\n    if (!issues || typeof issues !== 'object') return {};\n    const map: FieldErrors = {};\n    Object.entries(issues as Record<string, unknown>).forEach(([key, value]) => {\n        if (typeof value === 'string') {\n            map[key] = value;\n        } else if (value && typeof value === 'object' && '_errors' in value) {\n            const errors = (value as { _errors?: unknown[] })._errors;\n            if (Array.isArray(errors) && errors.length > 0 && typeof errors[0] === 'string') {\n                map[key] = errors[0];\n            }\n        }\n    });\n    return map;\n};\n\nconst hideServerShell = () => {\n    const shell = document.querySelector('[data-loo-edit-shell]');\n    if (shell && shell instanceof HTMLElement) {\n        shell.style.display = 'none';\n    }\n};\n\nconst scrollToSelector = (selector: string, options?: ScrollIntoViewOptions) => {\n    if (typeof document === 'undefined') return;\n    const el = document.querySelector(selector);\n    if (el && el instanceof HTMLElement) {\n        el.scrollIntoView({\n            behavior: 'smooth',\n            block: 'center',\n            ...options,\n        });\n    }\n};\n\nconst focusFieldByName = (name: string) => {\n    if (typeof document === 'undefined') return;\n    const field = document.querySelector(`[name=\"${name}\"]`) as HTMLElement | null;\n    if (field) {\n        field.focus({ preventScroll: true });\n        field.scrollIntoView({ behavior: 'smooth', block: 'center' });\n    }\n};\n\nconst focusFirstErrorField = (fieldErrors: FieldErrors) => {\n    const firstKey = Object.keys(fieldErrors)[0];\n    if (!firstKey) return;\n    requestAnimationFrame(() => focusFieldByName(firstKey));\n};\n\nconst redirectToDetails = (id: string) => {\n    if (typeof window === 'undefined') return;\n    window.location.assign(`/admin/loos/${id}?source=edit`);\n};\n\nexport const EditLooApp = () => {\n    const config = usePageConfig();\n\n    if (!config) {\n        return <div class=\"form-card\">Loading edit formâ€¦</div>;\n    }\n\n    return <EditLooAppContent config={config} />;\n};\n\nconst EditLooAppContent = ({ config }: { config: EditPageConfig }) => {\n    const { form, updateField, updateTriState, updateOpeningHours, updateLocation } = useLooForm(config.defaults);\n    const [status, setStatus] = useState<SubmissionStatus>('idle');\n    const [errors, setErrors] = useState<FieldErrors>({});\n    const [serverError, setServerError] = useState<string | null>(null);\n\n    useEffect(() => {\n        hideServerShell();\n    }, []);\n\n    const handleTriStateChange = (field: keyof typeof form, value: TriStateValue) => {\n        updateTriState(field, value);\n    };\n\n    const handleSubmit = async (event: Event) => {\n        event.preventDefault();\n        setServerError(null);\n\n        const validation = validateForm(form);\n        if (!validation.success) {\n            setErrors(validation.errors || {});\n            setStatus('error');\n            focusFirstErrorField(validation.errors || {});\n            return;\n        }\n\n        hideServerShell();\n        setErrors({});\n        setStatus('saving');\n\n        try {\n            const response = await fetch(config.api.update, {\n                method: 'PUT',\n                headers: {\n                    'content-type': 'application/json',\n                },\n                credentials: 'same-origin',\n                body: JSON.stringify(buildPayload(validation.data)),\n            });\n\n            if (response.status === 401) {\n                window.location.href = '/admin/login';\n                return;\n            }\n\n            if (!response.ok) {\n                const body = await response.json().catch(() => null);\n                const apiIssues = body && typeof body === 'object' ? (body as Record<string, unknown>).issues : null;\n                if (apiIssues) {\n                    const issueMap = mapIssueObject(apiIssues);\n                    setErrors(issueMap);\n                    focusFirstErrorField(issueMap);\n                }\n                const message =\n                    body && typeof body === 'object' && typeof (body as { message?: unknown }).message === 'string'\n                        ? (body as { message: string }).message\n                        : 'The API rejected this request.';\n                setServerError(message);\n                setStatus('error');\n                requestAnimationFrame(() => scrollToSelector('[data-error-banner]', { block: 'center' }));\n                return;\n            }\n\n            // Redirect to detail page after successful edit\n            redirectToDetails(config.looId);\n        } catch (error) {\n            console.error('Failed to submit loo edit request', error);\n            setServerError('Unexpected error while saving. Please try again.');\n            setStatus('error');\n            requestAnimationFrame(() => scrollToSelector('[data-error-banner]', { block: 'center' }));\n        }\n    };\n\n    return (\n        <LooForm\n            form={form}\n            errors={errors}\n            status={status}\n            serverError={serverError}\n            formId=\"loo-edit-form\"\n            mode=\"edit\"\n            onFieldChange={(field, value) => updateField(field, value)}\n            onTriStateChange={handleTriStateChange}\n            onOpeningHoursChange={updateOpeningHours}\n            onLocationChange={updateLocation}\n            onSubmit={handleSubmit}\n        />\n    );\n};\n","/** @jsxImportSource hono/jsx/dom */\n\nimport { render } from 'hono/jsx/dom';\nimport { EditLooApp } from './EditLooApp.client';\n\nconst hideServerShell = () => {\n    const shell = document.querySelector('[data-loo-edit-shell]');\n    if (shell && shell instanceof HTMLElement) {\n        shell.style.display = 'none';\n    }\n};\n\nif (typeof window !== 'undefined') {\n    const mount = () => {\n        hideServerShell();\n        const root = document.getElementById('loo-edit-root');\n        if (!root) {\n            console.error('Edit form root not found');\n            return;\n        }\n        render(<EditLooApp />, root);\n    };\n\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', mount);\n    } else {\n        mount();\n    }\n}\n"],"names":["parseConfig","scriptId","script","content","error","usePageConfig","config","setConfig","useState","useEffect","parsed","mapIssueObject","issues","map","key","value","errors","hideServerShell","shell","scrollToSelector","selector","options","el","focusFieldByName","name","field","focusFirstErrorField","fieldErrors","firstKey","redirectToDetails","id","EditLooApp","jsx","EditLooAppContent","form","updateField","updateTriState","updateOpeningHours","updateLocation","useLooForm","status","setStatus","setErrors","serverError","setServerError","LooForm","event","validation","validateForm","response","buildPayload","body","apiIssues","issueMap","message","mount","root","render"],"mappings":"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"}